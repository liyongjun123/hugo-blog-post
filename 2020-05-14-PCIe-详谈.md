---
title: "PCIe ËØ¶Ë∞à"
date: 2020-05-14T09:35:53+08:00
draft: false
categories: ["Á°¨‰ª∂"]
tags: ["ÁªèÈ™å","ÂçèËÆÆ"]
toc: "true"
url: "/2020/05/14/pcie-detail.html"
---



## ÊòØ‰ªÄ‰πà

Êé•Âè£„ÄÅÊÄªÁ∫ø



## Âá∫Áé∞ÁöÑËøáÁ®ã

- Êó©ÊúüËÆ°ÁÆóÊú∫‰∏≠ÂêÑÁßçËÆæÂ§á‰ΩøÁî®ÁöÑÊÄªÁ∫øÊé•Âè£ÊòØÂÆåÂÖ®‰∏ç‰∏ÄÊ†∑ÁöÑ
  - ÁΩëÂç°Áî®ÁùÄÁΩëÂç°ÁöÑÊé•Âè£
  - Â£∞Âç°Áî®ËøôÂ£∞Âç°ÁöÑÊé•Âè£
  - ÊòæÂç°Áî®ÁùÄÊòæÂç°ÁöÑÊé•Âè£
- Êé•Âè£‰∏çÁªü‰∏ÄÔºå‰ª•ÂêéÂçáÁ∫ß‰πüÂè™ËÉΩ‰ΩøÁî®‰πãÂâçÊé•Âè£ÁöÑÂ§ñËÆæÔºåÊúâÂæàÂ§ßÁöÑÂ±ÄÈôêÊÄß
- ‰∏∫‰∫ÜËß£ÂÜ≥ËøôÁßçÁä∂ÂÜµ
  - IBM ËÅîÂêà intel Âà∂ÂÆö‰∫ÜÂ§ßÂêçÈºéÈºéÁöÑ ISA ÊÄªÁ∫øÔºàÁ¨¨‰∏Ä‰ª£ÊÄªÁ∫øÔºâ
    - ‰∏ä‰∏ñÁ∫™ 80 Âπ¥‰ª£
    - Âπ∂Ë°åÊÄªÁ∫ø
    - Áº∫ÁÇπ
      - Âπ∂Ë°åÊÄªÁ∫øÔºåÂΩìÊó∂ÁöÑÊäóÂπ≤Êâ∞ÊäÄÊúØ‰∏çÊàêÁÜüÔºåÈ¢ëÁéáÂ∞±Êó†Ê≥ïÂÅöÂà∞ÂæàÈ´òÔºåÂ∏¶ÂÆΩ 8 MB/s
      - ‰∏çËÉΩÂç≥ÊèíÂç≥Áî®ÔºåÈúÄË¶ÅÊâãÂä®ÂéªÂàÜÈÖçÁ≥ªÁªüËµÑÊ∫ê
      - ÊúÄÂ§ßÂè™ÊîØÊåÅ 6 ‰∏™Â§ñÂõ¥ËÆæÂ§á
  - PCI ÊÄªÁ∫øÔºàÁ¨¨‰∫å‰ª£ÊÄªÁ∫øÔºâ
    - 132 MB/s
    - Âç≥ÊèíÂç≥Áî®
    - ‰∏ç‰æùËµñ‰∫éÂÖ∑‰ΩìÊüêÊ¨æ CPU ÁöÑÁã¨Á´ãÊÄªÁ∫ø
    - Áº∫ÁÇπ
      - ‰æùÊóßÈááÁî®Âπ∂Ë°åÊÄªÁ∫ø
      - ÂÖ±‰∫´ÊÄªÁ∫øÔºåÈ´òË¥üËΩΩ‰∏ãÂæàÂ§öËÆæÂ§á‰ºöÊä¢Â∏¶ÂÆΩ
      - ‰∏çÊîØÊåÅÁÉ≠ÊãîÊèí
  - PCIe ÊÄªÁ∫øÔºàÁ¨¨‰∏â‰ª£ÊÄªÁ∫øÔºågen3Ôºå3.0Ôºâ

## PCIe Êúâ‰∏§‰∏™Â≠òÂú®ÁöÑÂΩ¢ÊÄÅ

- PCIe Êé•Âè£
  - PCIe ÊèíÊßΩ
    - ÂèØ‰ª•Êèí PCIe Êé•Âè£ÁöÑ
      - ÊòæÂç°
      - ÁΩëÂç°
      - Âõ∫ÊÄÅÁ°¨Áõò
      - Êó†Á∫øÁΩëÂç°
      - ÊúâÁ∫øÁΩëÂç°
      - È£üË∞±ÈááÈõÜÂç°
    - ËøòÂèØ‰ª•Êää PCIe Êé•Âè£ËΩ¨ÊàêÂÖ∂‰ªñÊé•Âè£
      - PCIe ËΩ¨ M.2
      - PCIe ËΩ¨ USB
      - PCIe ËΩ¨ Type-c
- PCIe ÈÄöÈÅì
  - ÊØîÊñπËØ¥ M.2Âõ∫ÊÄÅÁ°¨ÁõòËôΩÁÑ∂Êé•Âè£ÁöÑÂΩ¢Áä∂ÊòØ M.2Ôºå‰ΩÜÊòØÊï∞ÊçÆ‰º†Ëæì‰æùËµñÁöÑÊòØ PCIe ÈÄöÈÅìÔºåPCIe Âú®ËøôÈáåÂ∞±ÊâøÊãÖÊï∞ÊçÆ‰º†ËæìÊÄªÁ∫øÁöÑ‰ΩúÁî®‰∫Ü„ÄÇÂõ†Ê≠§ÂèØ‰ª•ÁÆÄÂçïÁöÑÁêÜËß£ M.2 Â∞±ÊòØ‰∏Ä‰∏™Êç¢‰∫ÜÂΩ¢Áä∂ÁöÑ PCIe Êé•Âè£
  - Èõ∑Áîµ3 ‰πüÊòØÂà©Áî® PCIe ÈÄöÈÅìÊù•‰º†ËæìÊï∞ÊçÆÁöÑ

## PCIe ÁöÑÂ∏¶ÂÆΩ

PCIe ÁöÑÂ∏¶ÂÆΩÊòØÊ†πÊçÆÊé•Âè£ÁöÑÈïøÂ∫¶ËÆ°ÁÆóÁöÑ

PCIe X1„ÄÅPCIe X2„ÄÅPCIe X4„ÄÅPCIe X8„ÄÅPCIe X16

![PCIe](/images/PCIe.png)

‰ªª‰Ωï X16 ÁöÑËÆæÂ§áÈÉΩÂèØ‰ª•ÊèíÂú®Â∞æÈÉ®ÈùûÈó≠ÂêàÁöÑ X1 ÊßΩ‰∏≠ËøêË°åÔºåÂè™‰∏çËøáËøô‰∏™ËÆæÂ§áËÇØÂÆöÊòØÊó†Ê≥ïÂèëÊå•ÂÖ®ÈÉ®ÁöÑÊÄßËÉΩ‰∫Ü„ÄÇ

‰πüÂèØ‰ª•Êää X1 ÁöÑËÆæÂ§áÊèíÂú® X16 ÁöÑÊßΩ‰∏≠ËøêË°åÔºåÂè™‰∏çËøáËøôÊ†∑Â∞±Êµ™Ë¥πÊèíÊßΩÂ∏¶ÂÆΩ‰∫Ü„ÄÇ

ÊÆãË°Ä M.2 Âíå Èõ∑Áîµ3 ËØ¥ÁöÑÂ∞±ÊòØ PCIe X2 ÈÄüÁéáÁöÑÔºõ

Êª°Ë°Ä M.2 Âíå Èõ∑Áîµ3 ËØ¥ÁöÑÂ∞±ÊòØ PCIe X4 ÈÄüÁéáÁöÑ„ÄÇ

![PCIe ÈÄüÁéá](/images/PCIeÈÄüÁéá.jpg)



## PCIe ÂºïËÑöÂÆö‰πâ

![img](/images/pcieÂºïËÑöÂÆö‰πâ_1.jpg)

![img](/images/pcieÂºïËÑöÂÆö‰πâ_2.jpg)

![img](/images/pcieÂºïËÑöÂÆö‰πâ_3.jpg)

![img](/images/pcieÂºïËÑöÂÆö‰πâ_4.jpg)

![img](/images/pcieÂºïËÑöÂÆö‰πâ_5.jpg)

‰∏ãÈù¢ËøôÁØáÊñáÁ´†ÁöÑÂêéÂçäÈÉ®ÂàÜÊúâÂØπ PCIe ÁöÑÊîπÈÄ†ÂÆûÈ™åÔºåÂÄºÂæóÂ≠¶‰π†

[J1900ËΩØË∑ØÁî±Âä†Ë£ÖÊó†Á∫øÁΩëÂç°ÂÅöAPÊäòËÖæËÆ∞](https://www.jarviswang.me/?p=725)



## Â≠¶‰π†Ëµ∑Ê≠•

### 01. PCI-Express

https://blog.csdn.net/u013140088/category_7015733.html

### 02. PCIeÂü∫Á°ÄÁü•ËØÜ

https://blog.csdn.net/zqixiao_09/article/details/51842542

### 03. PCIeÊÄªÁ∫øÂü∫Êú¨Ê¶ÇÂøµ

http://www.elecfans.com/d/664309.html

### 04. PCIeÂ∫îÁî®ÂÆûÊàò Ôºà‰ªòË¥πÔºâ

https://blog.csdn.net/weiaipan1314/category_9722794.html?utm_source=ffzl_BWzd

### 05. Linux ‰∏ãÁöÑ PCIE ËÆæÂ§áÈ©±Âä®ËÆæËÆ°‰∏éÂÆûÁé∞

https://max.book118.com/html/2019/1026/6201155022002120.shtm

### 06. Linux‰∏ãPCIËÆæÂ§áÈ©±Âä®ÂºÄÂèëËØ¶Ëß£

https://blog.csdn.net/weixin_42092278/article/details/81638530

### 07. mtk7621È©±Âä®

http://doc.okbase.net/22510743/archive/259892.html

### 08. rt3070 Êó†Á∫øÁΩëÂç°ÁßªÊ§ç

http://blog.chinaunix.net/uid-30407552-id-5182640.html

### 09. Êó†Á∫øÈ©±Âä®ÁßªÊ§ç‰∏éÂºÄÂèë-MTKÊ∫êÁ†ÅÂàÜÊûê

https://blog.csdn.net/u011212816/article/details/81137126

### 10. PCIeÊâ´Áõ≤

https://blog.csdn.net/kunkliu/category_9091238.html

### 11. „Äê14„ÄëPCIeÊû∂ÊûÑ‰∏ãmemoryÁ©∫Èó¥„ÄÅIOÁ©∫Èó¥„ÄÅPCIeÈÖçÁΩÆÁ©∫Èó¥ÁÆÄ‰ªã

armÁªü‰∏ÄÁºñÂùÄÔºåx86Áã¨Á´ãÁºñÂùÄ

https://blog.csdn.net/linjiasen/article/details/87944672

### 12. PCIeÂ≠¶‰π†Á¨îËÆ∞Ôºà‰∏ÄÔºâ‚Äî‚ÄîÁ°¨‰ª∂ËÆæÂ§áËØÜÂà´Êâ´Áõ≤ÁØá(Âè≤Êó†Ââç‰æãÁöÑÂ•ΩÊñáÁ´†)

https://blog.csdn.net/codectq/article/details/104472150

### 13. LinuxÈÇ£‰∫õ‰∫ãÂÑø ‰πã ÊàëÊòØPCI

https://blog.csdn.net/fudan_abc/category_345294.html





### 1.1  PCIe Êúâ link ÁöÑÊ¶ÇÂøµ

link ÂèØ‰ª•Êúâ 1„ÄÅ2„ÄÅ4„ÄÅ8„ÄÅ16„ÄÅ32 Êù° lane

![img](/images/pcie-link.png)

‰∏ÄÊù° lane ÊòØÁî±‰∏Ä‰∏™ transmitter Âíå ‰∏Ä‰∏™ receiver ÊûÑÊàê

![img](/images/pcie-lane.png)

### 1.2  PCI ÈóÆÈ¢ò

‰∏Ä„ÄÅflight time

‰∫å„ÄÅclock skew

‰∏â„ÄÅsignal skew

### 1.3 PCIe Ëß£ÂÜ≥

‰∏Ä„ÄÅÊï∞ÊçÆÊµÅ‰∏≠ÂåÖÂê´‰∫Ü clock,‰∏çÈúÄË¶ÅÂ§ñÂä† clockÔºåÊâÄ‰ª•ÔºåÊó†ËÆ∫ clock Âë®ÊúüÂ§öÂ∞èÔºåÊàñËÄÖÊó†ËÆ∫‰ø°Âè∑ÈúÄË¶ÅÂ§öÈïøÁöÑ‰º†Êí≠Êó∂Èó¥ÔºåÈÉΩ‰∏çÂ≠òÂú® flight time Ëøô‰∏™ÈóÆÈ¢ò

‰∫å„ÄÅÂêåÊ†∑ÔºåÂõ†‰∏∫Ê≤°ÊúâÂ§ñÈÉ® clockÔºåÂ∞±Ê≤°Êúâclock skew ÁöÑÈóÆÈ¢ò

‰∏â„ÄÅÂØπ‰∫éÂè™Êúâ‰∏ÄÊù°laneÊòØÊ≤°Êúâsignal skweÁöÑÈóÆÈ¢òÔºå‰ΩÜÂØπ‰∫éÂ§öÊù°laneÔºåPCIe ‰πüÊúâËß£ÂÜ≥ÂäûÊ≥ï

### 1.4 PCIe ‰ø°Âè∑Á∫ø

~~PCIe ‚âà SPI(ÂéªÊéâCS) + RS485~~

~~Âç≥ÔºåPCIeÂÉèSPI‰∏ÄÊ†∑‰ΩøÁî®ÂêåÊ≠•Êó∂ÈíüÁ∫øÔºåÂÖ®ÂèåÂ∑•ÔºõÂÉèRS485‰∏ÄÊ†∑‰ΩøÁî®Â∑ÆÂàÜ‰ø°Âè∑‰º†Ëæì„ÄÇPCIeÁöÑCLK„ÄÅRx„ÄÅTxÂùá‰ΩøÁî®Â∑ÆÂàÜ‰ø°Âè∑‰º†Ëæì„ÄÇÁâõÈÄºüêÆÔºÅ~~

### 1.5 PCIe ÊãìÊâëÁªìÊûÑ

![pcieÊãìÊâëÁªìÊûÑ](/images/pcieÊãìÊâëÁªìÊûÑ.png)

### 1.6 PCIe ÊòØÁÇπÂØπÁÇπ



### 4.1 PCIe Â±ÇÂèäÁªìÊûÑ

PCIe ÊÄªÁ∫øÈááÁî®‰∏≤Ë°åÈÄö‰ø°ÊñπÂºèÔºå‰ΩøÁî®Êï∞ÊçÆÂåÖ(Packet)ËøõË°åÊï∞ÊçÆ‰º†Ëæì„ÄÇ

Âú®PCIeÊÄªÁ∫ø‰∏≠ÔºåÊï∞ÊçÆÊä•ÊñáÂú®Êé•Êî∂ÂíåÂèëÈÄÅËøáÁ®ã‰∏≠ÔºåÈúÄË¶ÅÈÄöËøáÂ§ö‰∏™Â±ÇÊ¨°ÔºåÂåÖÊã¨‰∫ãÂä°Â±Ç(Transaction Layer)„ÄÅÊï∞ÊçÆÈìæË∑ØÂ±Ç(Data Link Layer)„ÄÅÁâ©ÁêÜÂ±Ç(Physical Layer)„ÄÇ

![img](/images/pcieÂ±ÇÁ∫ßÁªìÊûÑ.jpg)



### 4.2 TLP

Transaction Layer Packet„ÄÇ

Host ‰∏é PCIe ËÆæÂ§á‰πãÈó¥ÔºåÊï∞ÊçÆ‰º†ËæìÈÉΩÊòØ‰ª• Packet ÂΩ¢ÂºèËøõË°åÁöÑÔºõ

‰∫ãÂä°Â±ÇÊ†πÊçÆ‰∏äÂ±Ç(ËΩØ‰ª∂Â±ÇÊàñËÄÖÂ∫îÁî®Â±Ç)ËØ∑Ê±Ç(Request)ÁöÑÁ±ªÂûã„ÄÅÁõÆÁöÑÂú∞ÂùÄÂíåÂÖ∂ÂÆÉÁõ∏ÂÖ≥Â±ûÊÄßÔºåÊääËøô‰∫õËØ∑Ê±ÇÊâìÂåÖÔºå‰∫ßÁîüTLP„ÄÇ

ÁÑ∂ÂêéËøô‰∫õTLPÂæÄ‰∏ãÔºåÁªèÂéÜÊï∞ÊçÆÈìæË∑ØÂ±Ç„ÄÅÁâ©ÁêÜÂ±ÇÔºåÊúÄÁªàËææÂà∞ÁõÆÊ†áËÆæÂ§á„ÄÇ

ÊØè‰∏™‰∫ãÁâ©ÈÉΩË¶ÅÈÄöËøá‰∏Ä‰∏™ÊàñËÄÖÂ§ö‰∏™TLPÂåÖÂÆûÁé∞„ÄÇ

TLP‰∏ªË¶ÅÁî±‰∏âÈÉ®ÂàÜÁªÑÊàêÔºöHeader„ÄÅData„ÄÅCRC „ÄÇ

TLPÁîü‰∫éÂèëÈÄÅÁ´ØÁöÑ‰∫ãÂä°Â±ÇÔºåÁªà‰∫éÊé•Êî∂Á´ØÁöÑ‰∫ãÂä°Â±Ç„ÄÇ

#### 4.2.1 TLP Header

TLP Header Èïø 3„ÄÅ4 ‰∏™ DW„ÄÇ

ÂåÖÊã¨ÂèëÈÄÅËÄÖÁöÑÂêÑÁßçÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÁõÆÊ†áÂú∞ÂùÄ(ËØ•TLPË¶ÅÁªôË∞Å)„ÄÅTLPÁ±ªÂûã(Memory readÔºåMemory writeÁ≠â)„ÄÅÊï∞ÊçÆÈïøÂ∫¶(Â¶ÇÊûúÊúâÁöÑËØù)Á≠âÁ≠â„ÄÇ

![img](/images/TLP_Header.jpg)

Á¨¨1‰∏™ÂèåÂ≠óÊòØÊâÄÊúâÁ±ªÂûãÁöÑTLPÈÉΩÊúâÁöÑÔºõÂêéÈù¢ÁöÑ3‰∏™ÂèåÂ≠óÊ†πÊçÆ Fmt„ÄÅTypeÂ±ûÊÄßÊîπÂèò„ÄÇ

![img](/images/TLP_Header_Fmt_Type.jpg)

#### 4.2.2 TLP Data

Âç≥ TLP ÁöÑ PayloadÂüüÔºåÁî®Êù•ÊîæÊúâÊïàËΩΩËç∑Êï∞ÊçÆ„ÄÇËØ•Âüü‰∏çÊòØÂøÖÈ°ªÁöÑÔºåÂõ†‰∏∫Âπ∂‰∏çÊòØÊØè‰∏™ TLP ÈÉΩÂøÖÈ°ªÊê∫Â∏¶Êï∞ÊçÆÁöÑÔºåÊØîÂ¶Ç Memory Read TLPÔºåÂÆÉÂè™ÊòØ‰∏Ä‰∏™ËØ∑Ê±ÇÔºåÊï∞ÊçÆÊòØÁî±ÁõÆÊ†áËÆæÂ§áÈÄöËøá Completion TLP ËøîÂõûÁöÑ„ÄÇ

‰∏Ä‰∏™ TLP ÊúÄÂ§ßËΩΩÈáèÊòØ4KBÔºåÊï∞ÊçÆÈïøÂ∫¶Â§ß‰∫é4KBÁöÑËØùÔºåÂ∞±ÈúÄË¶ÅÂàÜÂá†‰∏™TLP‰º†Ëæì„ÄÇ

#### 4.2.3 CRC

ÂØπ Header Âíå Data ÁîüÊàê‰∏Ä‰∏™ CRC„ÄÇ

ÂÆÉÊòØÂèØÈÄâÁöÑÔºåÂèØ‰ª•ËÆæÁΩÆ‰∏çÂä† CRC„ÄÇ

### 4.3 PCIe ÈÖçÁΩÆÁ©∫Èó¥

ÊØè‰∏™ PCIe ËÆæÂ§áÔºåÈÉΩÊúâËøô‰πà‰∏ÄÊÆµÁ©∫Èó¥ÔºåHost ËΩØ‰ª∂ÂèØ‰ª•ËØªÂèñÂÆÉËé∑ÂæóËØ•ËÆæÂ§áÁöÑ‰∏Ä‰∫õ‰ø°ÊÅØÔºå‰πüÂèØ‰ª•ÈÄöËøáÂÆÉÊù•ÈÖçÁΩÆËØ•ËÆæÂ§áÔºåËøôÊÆµÊâ£ÂáèÂ∞±Âè´ÂÅö PCIe ÁöÑÈÖçÁΩÆÁ©∫Èó¥„ÄÇ

PCIe Êúâ‰∏§ÁßçÁ±ªÂûãÁöÑÈÖçÁΩÆÁ©∫Èó¥ÔºåType0 Âíå Type1ÔºåÂàÜÂà´ÂØπÂ∫îÁ´ØÁÇπËÆæÂ§á(Endpoint)ÂíåÊ°•ËÆæÂ§á(RootÂíåSwitchÁ´ØÂè£‰∏≠ÁöÑP2PÊ°•)ÔºåÊàë‰ª¨Âè™ËÆ®ËÆ∫Á´ØÁÇπËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥ÂÖ∑‰ΩìÂ±ûÊÄß„ÄÇ

### 4.4 PCIe Á©∫Èó¥

PCIeÂÜÖÈÉ®ÊúâÈÖçÁΩÆÁ©∫Èó¥„ÄÅmemoryÁ©∫Èó¥„ÄÅIOÁ©∫Èó¥(‰∏çËÆ®ËÆ∫ÔºåÊöÇ‰∏çÁî®)„ÄÇ

Â§ÑÁêÜÂô®ËÆøÈóÆËøô‰∫õÁ©∫Èó¥ÈÉΩÊòØÂú®ÂºÄÊú∫ÁöÑÊó∂ÂÄôÊèêÂâçËøõË°å‰∫ÜÂú∞ÂùÄÊò†Â∞Ñ„ÄÇ

Â§ÑÁêÜÂô®ËÆøÈóÆÈÖçÁΩÆÁ©∫Èó¥Ëé∑ÂæóËÆæÂ§áÁöÑÁä∂ÊÄÅÂíåËÆæÂ§áÂ±ûÊÄß‰ø°ÊÅØÔºåÂ§ÑÁêÜÂô®ËÆøÈóÆmemoryÁ©∫Èó¥ÂèØ‰ª•ÂíåPCIeËÆæÂ§áËøõË°åÊï∞ÊçÆ‰∫§‰∫í„ÄÇ

### 4.5 BARÂØÑÂ≠òÂô®ÂíåBARÁ©∫Èó¥

BARÂØÑÂ≠òÂô®Âú®PCIeÈÖçÁΩÆÁ©∫Èó¥ÈáåÈù¢Ôºå‰∏Ä‰∏™PCIeËÆæÂ§áÔºåÂèØËÉΩÊúâËã•Âπ≤‰∏™ÂÜÖÈÉ®Á©∫Èó¥(ÊúÄÂ§ö6‰∏™)ÈúÄË¶ÅÊò†Â∞ÑÂà∞**‰∏ªÊú∫memory**Âú∞ÂùÄÁ©∫Èó¥ÔºåËÆæÂ§áÂá∫ÂéÇÊó∂ÔºåËøô‰∫õÁ©∫Èó¥ÁöÑÂ§ßÂ∞èÂíåÂ±ûÊÄßÈÉΩÂÜôÂú®



#### 5.1 PCIe ËÆæÂ§áÈ©±Âä®

~~PCIe ÊÄªÁ∫ø‰∏äÁöÑÂêÑÁßçÂ§ñËÆæÈ©±Âä®ÂèØ‰ª•Áúã‰ΩúÊòØÂ≠óÁ¨¶ËÆæÂ§áÈ©±Âä®„ÄÇ~~

PCIe ËÆæÂ§áÈ©±Âä®ÔºöLinux ÂÜÖÊ†∏ÁöÑ PCIe ËÆæÂ§áÈ©±Âä® + ÊÄªÁ∫ø‰∏äÊâÄËΩΩËÆæÂ§áÊú¨Ë∫´ÁöÑÈ©±Âä®„ÄÇ

ÂâçËÄÖ‰∏çÈúÄË¶ÅÊàë‰ª¨ÂéªÂÆûÁé∞Ôºå‰πüÂæàÈöæÂÆûÁé∞

#### 5.2 Intel

PCIe Áî±IntelÊèêÂá∫ÔºåÈ´òÈÄü‰∏≤Ë°åÁÇπÂØπÁÇπÔºåÁã¨‰∫´ÈÄöÈÅìÂ∏¶ÂÆΩ„ÄÇ

#### 5.3 /dev

/dev ‰∏≠ÊîæÁöÑÈÉΩÊòØÂ≠óÁ¨¶ËÆæÂ§á„ÄÅÂùóËÆæÂ§áÔºåÁΩëÁªúËÆæÂ§áÂπ∂‰∏çÂ±û‰∫éÊ≠§‰∫åÁ±ªÔºåÊó†Ê≥ïÂÆûÁé∞ÂÆÉ‰ª¨ÁöÑÊé•Âè£„ÄÇ [üîó](https://forum.ubuntu.org.cn/viewtopic.php?p=3057815)

![LinuxËÆæÂ§áÈ©±Âä®‰∏éÊï¥‰∏™ËΩØÁ°¨‰ª∂Á≥ªÁªüÁöÑÂÖ≥Á≥ª](/images/LinuxËÆæÂ§áÈ©±Âä®‰∏éÊï¥‰∏™ËΩØÁ°¨‰ª∂Á≥ªÁªüÁöÑÂÖ≥Á≥ª.png)

ÁΩëÁªúËÆæÂ§áÂπ∂Ê≤°ÊúâË¥ØÂΩª‚Äú‰∏ÄÂàáÁöÜÊñá‰ª∂‚ÄúÁöÑÊÄùÊÉ≥ÔºåÁΩëÁªúËÆæÂ§á‰∏ç‰ª•/dev‰∏ãÁöÑËÆæÂ§áÊñá‰ª∂‰∏∫Êé•Âè£Ôºå**Áî®Êà∑Á®ãÂ∫èÈÄöËøásocket‰Ωú‰∏∫ËÆøÈóÆÁ°¨‰ª∂ÁöÑÊé•Âè£**„ÄÇ[üîó](https://www.cnblogs.com/xiaojiang1025/p/6486267.html)



#### 6.1 PCI ËÆæÂ§áÈ©±Âä®ÁªÑÊàê

PCIÊú¨Ë¥®‰∏äÂ∞±ÊòØ‰∏ÄÁßçÊÄªÁ∫øÔºåÂÖ∑‰ΩìÁöÑPCIËÆæÂ§áÂèØ‰ª•ÊòØÂ≠óÁ¨¶ËÆæÂ§á„ÄÅÁΩëÁªúËÆæÂ§á„ÄÅUSBËÆæÂ§áÁ≠âÔºåÊâÄ‰ª•PCIËÆæÂ§áÈ©±Âä®Â∫îËØ•ÂåÖÂê´‰∏§ÈÉ®ÂàÜ

1. PCI È©±Âä®
2. Ê†πÊçÆÈúÄÊ±ÇÁöÑËÆæÂ§áÈ©±Âä®

Ê†πÊçÆÈúÄÊ±ÇÁöÑËÆæÂ§áÈ©±Âä®ÊòØÊúÄÁªàÁõÆÁöÑÔºåPCIÈ©±Âä®Âè™ÊòØÊâãÊÆµÂ∏ÆÂä©ÈúÄÊ±ÇËÆæÂ§áÈ©±Âä®ËææÂà∞ÊúÄÁªàÁõÆÁöÑËÄåÂ∑≤„ÄÇÊç¢Âè•ËØùËØ¥PCIËÆæÂ§áÈ©±Âä®‰∏ç‰ªÖË¶ÅÂÆûÁé∞PCIÈ©±Âä®ÔºåËøòË¶ÅÂÆûÁé∞Ê†πÊçÆÈúÄÊ±ÇÁöÑËÆæÂ§áÈ©±Âä®„ÄÇ

![PCIËÆæÂ§áÈ©±Âä®](/home/liyongjun/hugoblog/content/post/images/PCIËÆæÂ§áÈ©±Âä®.png)



#### 7.1 PCI ‰∏âÁßçÂú∞ÂùÄÁ©∫Èó¥

PCI ËÆæÂ§á‰∏äÁî±‰∏âÁßçÂú∞ÂùÄÁ©∫Èó¥ÔºöPCIÁöÑI/OÁ©∫Èó¥„ÄÅPCIÁöÑÂ≠òÂÇ®Á©∫Èó¥„ÄÅPCIÁöÑÈÖçÁΩÆÁ©∫Èó¥„ÄÇ

CPUÂèØ‰ª•ËÆøÈóÆPCIËÆæÂ§á‰∏äÁöÑÊâÄÊúâÂú∞ÂùÄÁ©∫Èó¥„ÄÇÂÖ∂‰∏≠I/OÁ©∫Èó¥ÂíåÂ≠òÂÇ®Á©∫Èó¥Êèê‰æõÁªôËÆæÂ§áÈ©±Âä®Á®ãÂ∫è‰ΩøÁî®ÔºåËÄåÈÖçÁΩÆÁ©∫Èó¥ÂàôÁî±LinuxÂÜÖÊ†∏‰∏≠ÁöÑPCIÂàùÂßãÂåñ‰ª£Á†Å‰ΩøÁî®„ÄÇÂÜÖÊ†∏Âú®ÂêØÂä®Êó∂Ë¥üË¥£ÂØπÊâÄÊúâPCIËÆæÂ§áËøõË°åÂàùÂßãÂåñÔºåÈÖçÁΩÆÂ•ΩÊâÄÊúâÁöÑPCIËÆæÂ§áÔºåÂåÖÊã¨‰∏≠Êñ≠Âè∑‰ª•ÂèäI/OÂü∫ÂùÄÔºåÂπ∂Âú®Êñá‰ª∂` /proc/pci ` ? ` /proc/bus/pci `‰∏≠ÂàóÂá∫ÊâÄÊúâÊâæÂà∞ÁöÑPCIËÆæÂ§áÔºå‰ª•ÂèäËøô‰∫õËÆæÂ§áÁöÑÂèÇÊï∞ÂíåÂ±ûÊÄß„ÄÇ

#### 7.2 È©±Âä®‰∏≠ÁöÑ struct

Linux È©±Âä®Á®ãÂ∫èÈÄöÂ∏∏‰ΩøÁî®ÁªìÊûÑ‰Ωì(struct)Êù•Ë°®Á§∫‰∏ÄÁßçËÆæÂ§áÔºåËÄåÁªìÊûÑ‰ΩìÂèòÈáèÂàô‰ª£Ë°®‰∏ÄÂÖ∑‰ΩìËÆæÂ§áÔºåËØ•ÂèòÈáèÂ≠òÊîæ‰∫Ü‰∏éËØ•ËÆæÂ§áÁõ∏ÂÖ≥ÁöÑÊâÄÊúâ‰ø°ÊÅØ„ÄÇÂ•ΩÁöÑÈ©±Âä®Á®ãÂ∫èÈÉΩÂ∫îËØ•ËÉΩÈ©±Âä®Â§ö‰∏™ÂêåÁßçËÆæÂ§áÔºåÊØè‰∏™ËÆæÂ§á‰πãÈó¥Áî®Ê¨°ËÆæÂ§áÂè∑ËøõË°åÂå∫ÂàÜÔºåÊ¨°ËÆæÂ§áÂè∑Á≠â‰ª∑‰∫éÁªìÊûÑ‰ΩìÊï∞ÁªÑ‰∏ãÊ†á„ÄÇ











## ‰ª£Á†Å

hello_pcie.c

### 1

```c
// #define DMA_BUFFER_SIZE 1*1024*1024 
#define DMA_BUFFER_SIZE 512
```



### 2

```c
/*
 * The pci_dev structure is used to describe PCI devices.
 */
struct pci_dev {
    	// ÊÄªÁ∫øËÆæÂ§áÈìæË°®ÂÖÉÁ¥†bus_listÔºöÊØè‰∏™ pci_dev ÁªìÊûÑÈô§‰∫ÜÈìæÊé•Âà∞ÂÖ®Â±ÄËÆæÂ§áÈìæË°®‰∏≠Â§ñÔºå
    	// Ëøò‰ºöÈÄöËøáËøô‰∏™ÊàêÂëòÈìæÊé•Âà∞ÂÖ∂ÊâÄÂ±û PCI ÊÄªÁ∫øÁöÑËÆæÂ§áÈìæË°®‰∏≠„ÄÇ
    	// ÊØè‰∏ÄÊù° PCI ÊÄªÁ∫øÔºåÈÉΩÁª¥Êä§‰∏ÄÊù°ÂÆÉËá™Â∑±ÁöÑËÆæÂ§áÈìæË°®ËßÜÂõæÔºå‰ª•‰æøÊèèËø∞ÊâÄÊúâËøûÊé•Âú®ËØ•PCIÊÄªÁ∫ø‰∏äÁöÑËÆæÂ§á„ÄÇ
    	// ÂÖ∂Ë°®Â§¥Áî±PCIÊÄªÁ∫øÁöÑpci_busÁªìÊûÑ‰∏≠ÁöÑ devices ÊàêÂëòÊâÄÊèèËø∞
        struct list_head bus_list;      /* node in per-bus list */	
    	// ÊÄªÁ∫øÊåáÈíàbusÔºöÊåáÂêëËøô‰∏™ PCI ËÆæÂ§áÊâÄÂú®ÁöÑ PCI ÊÄªÁ∫øÁöÑ pci_bus ÁªìÊûÑ„ÄÇ
    	// Âõ†Ê≠§ÂØπ‰∫éÊ°•ËÆæÂ§áËÄåË®ÄÔºåbus ÊåáÈíàÂ∞ÜÊåáÂêëÊ°•ËÆæÂ§áÁöÑ‰∏ªÊÄªÁ∫ø(primay bus)Ôºå‰πüÂç≥ÊåáÂêëÊ°•ËÆæÂ§áÊâÄÂú®ÁöÑPCIÊÄªÁ∫ø
        struct pci_bus  *bus;           /* bus this device is on */
    	// ÊåáÈíàsubordinateÔºöÊåáÂêëËøô‰∏™ PCI ËÆæÂ§áÊâÄÊ°•Êé•ÁöÑ‰∏ãÁ∫ßÊÄªÁ∫ø„ÄÇ
    	// Ëøô‰∏™ÊåáÈíàÊàêÂëò‰ªÖÂØπÊ°•Êé•ËÆæÂ§áÊâçÊúâÊÑè‰πâÔºåËÄåÂØπ‰∏ÄËà¨ÈùûÊ°•PCIËÆæÂ§áËÄåË®ÄÔºåËØ•ÊåáÈíàÊàêÂëòÊÄªÊòØ‰∏∫NULL
        struct pci_bus  *subordinate;   /* bus this device bridges to */

    	// Êó†Á±ªÂûãÊåáÈíà sysdataÔºöÊåáÂêë‰∏ÄÁâáÂæÖÂÆö‰∫éÁ≥ªÁªüÁöÑÊâ©Â±ïÊï∞ÊçÆ
        void            *sysdata;       /* hook for sys-specific extension */
    
    	// ÊåáÂêëËØ• PCI ËÆæÂ§áÂú® /proc Êñá‰ª∂Á≥ªÁªü‰∏≠ÂØπÂ∫îÁöÑÁõÆÂΩïÈ°π
        struct proc_dir_entry *procent; /* device entry in /proc/bus/pci */
        struct pci_slot *slot;          /* Physical slot this device is in */

    	// PCI ËÆæÂ§áÁöÑËÆæÂ§áÂäüËÉΩÂè∑
        unsigned int    devfn;          /* encoded device & function index */
    	// 16‰ΩçÊó†Á¨¶Âè∑Êï¥Êï∞ÔºåË°®Á§∫ PCI ËÆæÂ§áÁöÑÂéÇÂïÜID
        unsigned short  vendor;
    	// 16‰ΩçÊó†Á¨¶Âè∑Êï¥Êï∞ÔºåË°®Á§∫ PCI ËÆæÂ§áÁöÑËÆæÂ§áID
        unsigned short  device;
        unsigned short  subsystem_vendor;
        unsigned short  subsystem_device;
    	// 32‰ΩçÊó†Á¨¶Âè∑Êï¥Êï∞ÔºåË°®Á§∫ËØ• PCI ËÆæÂ§áÁöÑÁ±ªÂà´Ôºå
    	// ÂÖ∂‰∏≠ÔºåbitÔºª7Ôºö0ÔºΩ‰∏∫ÁºñÁ®ãÊé•Âè£ÔºåbitÔºª15Ôºö8ÔºΩ‰∏∫Â≠êÁ±ªÂà´‰ª£Á†ÅÔºåbit Ôºª23Ôºö16ÔºΩ‰∏∫Âü∫Á±ªÂà´‰ª£Á†ÅÔºå
    	// bitÔºª31Ôºö24ÔºΩÊó†ÊÑè‰πâ„ÄÇÊòæÁÑ∂ÔºåclassÊàêÂëòÁöÑ‰Ωé3Â≠óËäÇÂàöÂ•ΩÂØπÂ∫î‰∏éPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑÁ±ª‰ª£Á†Å
        unsigned int    class;          /* 3 bytes: (base,sub,prog-if) */
        u8              revision;       /* PCI revision, low byte of class word */
        u8              hdr_type;       /* PCI header type (`multi' flag masked out) */
#ifdef CONFIG_PCIEAER
        u16             aer_cap;        /* AER capability offset */
#endif
        u8              pcie_cap;       /* PCIe capability offset */
        u8              msi_cap;        /* MSI capability offset */
        u8              msix_cap;       /* MSI-X capability offset */
        u8              pcie_mpss:3;    /* PCIe Max Payload Size Supported */
        u8              rom_base_reg;   /* which config register controls the ROM */
        u8              pin;            /* which interrupt pin this device uses */
        u16             pcie_flags_reg; /* cached PCIe Capabilities Register */
        unsigned long   *dma_alias_mask;/* mask of enabled devfn aliases */

    	// ÊåáÂêëËøô‰∏™ PCI ËÆæÂ§áÊâÄÂØπÂ∫îÁöÑÈ©±Âä®Á®ãÂ∫èÂÆö‰πâÁöÑ pci_driver ÁªìÊûÑ„ÄÇÊØè‰∏Ä‰∏™pciËÆæÂ§áÈ©±Âä®Á®ãÂ∫èÈÉΩ
    	// ÂøÖÈ°ªÂÆö‰πâÂÆÉËá™Â∑±ÁöÑ pci_driver ÁªìÊûÑÊù•ÊèèËø∞ÂÆÉËá™Â∑±
        struct pci_driver *driver;      /* which driver has allocated this device */
        
    	// Áî®‰∫é DMA ÁöÑÊÄªÁ∫øÂú∞ÂùÄÊé©Á†ÅÔºå‰∏ÄËà¨Êù•ËØ¥ÔºåËøô‰∏™ÊàêÂëòÁöÑÂÄºÊòØ 0xffffffff
    	u64             dma_mask;       /* Mask of the bits of bus address this
                                           device implements.  Normally this is
                                           0xffffffff.  You only need to change
                                           this if your device has broken DMA
                                           or supports 64-bit transfers.  */

        struct device_dma_parameters dma_parms;
    
    	// ÂΩìÂâçÊìç‰ΩúÁä∂ÊÄÅ
        pci_power_t     current_state;  /* Current operating state. In ACPI-speak,
                                           this is D0-D3, D0 being fully functional,
                                           and D3 being off. */
        u8              pm_cap;         /* PM capability offset */
        unsigned int    pme_support:5;  /* Bitmask of states from which PME#
                                           can be generated */
        unsigned int    pme_poll:1;     /* Poll device's PME status bit */
        unsigned int    d1_support:1;   /* Low power state D1 is supported */
        unsigned int    d2_support:1;   /* Low power state D2 is supported */
        unsigned int    no_d1d2:1;      /* D1 and D2 are forbidden */
        unsigned int    no_d3cold:1;    /* D3cold is forbidden */
        unsigned int    bridge_d3:1;    /* Allow D3 for bridge */
        unsigned int    d3cold_allowed:1;       /* D3cold is allowed by user */
        unsigned int    mmio_always_on:1;       /* disallow turning off io/mem
                                                   decoding during bar sizing */
        unsigned int    wakeup_prepared:1;
        unsigned int    runtime_d3cold:1;       /* whether go through runtime
                                                   D3cold, not set for devices
                                                   powered on/off by the
                                                   corresponding bridge */
        unsigned int    skip_bus_pm:1;  /* Internal: Skip bus-level PM */
        unsigned int    ignore_hotplug:1;       /* Ignore hotplug events */
        unsigned int    hotplug_user_indicators:1; /* SlotCtl indicators
                                                      controlled exclusively by
                                                      user sysfs */
        unsigned int    clear_retrain_link:1;   /* Need to clear Retrain Link
                                                   bit manually */
        unsigned int    d3_delay;       /* D3->D0 transition time in ms */
        unsigned int    d3cold_delay;   /* D3cold->D0 transition time in ms */

#ifdef CONFIG_PCIEASPM
        struct pcie_link_state  *link_state;    /* ASPM link state */
        unsigned int    ltr_path:1;     /* Latency Tolerance Reporting
                                           supported from root to here */
#endif

        pci_channel_state_t error_state;        /* current connectivity state */
        struct  device  dev;            /* Generic device interface */

    	// ÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂ§ßÂ∞è
        int             cfg_size;       /* Size of configuration space */
        /*
         * Instead of touching interrupt line and base address registers
         * directly, use the values stored here. They might be different!
         */
        unsigned int    irq;
        struct resource resource[DEVICE_COUNT_RESOURCE]; /* I/O and memory regions + expansion ROMs */

        bool match_driver;              /* Skip attaching driver */
        /* These fields are used by common fixups */
        unsigned int    transparent:1;  /* Subtractive decode PCI bridge */
        unsigned int    multifunction:1;/* Part of multi-function device */
        /* keep track of device state */
        unsigned int    is_added:1;
        unsigned int    is_busmaster:1; /* device is busmaster */
        unsigned int    no_msi:1;       /* device may not use msi */
        unsigned int    no_64bit_msi:1; /* device may only use 32-bit MSIs */
        unsigned int    block_cfg_access:1;     /* config space access is blocked */
        unsigned int    broken_parity_status:1; /* Device generates false positive parity */
        unsigned int    irq_reroute_variant:2;  /* device needs IRQ rerouting variant */
        unsigned int    msi_enabled:1;
        unsigned int    msix_enabled:1;
        unsigned int    ari_enabled:1;  /* ARI forwarding */
        unsigned int    ats_enabled:1;  /* Address Translation Service */
        unsigned int    pasid_enabled:1;        /* Process Address Space ID */
        unsigned int    pri_enabled:1;          /* Page Request Interface */
        unsigned int    is_managed:1;
        unsigned int    needs_freset:1; /* Dev requires fundamental reset */
        unsigned int    state_saved:1;
        unsigned int    is_physfn:1;
        unsigned int    is_virtfn:1;
        unsigned int    reset_fn:1;
        unsigned int    is_hotplug_bridge:1;
        unsigned int    is_thunderbolt:1; /* Thunderbolt controller */
        /*
         * Devices marked being untrusted are the ones that can potentially
         * execute DMA attacks and similar. They are typically connected
         * through external ports such as Thunderbolt but not limited to
         * that. When an IOMMU is enabled they should be getting full
         * mappings to make sure they cannot access arbitrary memory.
         */
        unsigned int    untrusted:1;
        unsigned int    __aer_firmware_first_valid:1;
        unsigned int    __aer_firmware_first:1;
        unsigned int    broken_intx_masking:1; /* INTx masking can't be used */
        unsigned int    io_window_1k:1; /* Intel P2P bridge 1K I/O windows */
        unsigned int    irq_managed:1;
        unsigned int    has_secondary_link:1;
        unsigned int    non_compliant_bars:1;   /* broken BARs; ignore them */
        unsigned int    is_probed:1;            /* device probing in progress */
        pci_dev_flags_t dev_flags;
        atomic_t        enable_cnt;     /* pci_enable_device has been called */

        u32             saved_config_space[16]; /* config space saved at suspend time */
        struct hlist_head saved_cap_space;
        struct bin_attribute *rom_attr; /* attribute descriptor for sysfs ROM entry */
        int rom_attr_enabled;           /* has display of the rom attribute been enabled? */
        struct bin_attribute *res_attr[DEVICE_COUNT_RESOURCE]; /* sysfs file for resources */
        struct bin_attribute *res_attr_wc[DEVICE_COUNT_RESOURCE]; /* sysfs file for WC mapping of resources */

#ifdef CONFIG_PCIE_PTM
        unsigned int    ptm_root:1;
        unsigned int    ptm_enabled:1;
        u8              ptm_granularity;
#endif
#ifdef CONFIG_PCI_MSI
        const struct attribute_group **msi_irq_groups;
#endif
        struct pci_vpd *vpd;
#ifdef CONFIG_PCI_ATS
        union {
                struct pci_sriov *sriov;        /* SR-IOV capability related */
                struct pci_dev *physfn; /* the PF this VF is associated with */
        };
        u16             ats_cap;        /* ATS Capability offset */
        u8              ats_stu;        /* ATS Smallest Translation Unit */
        atomic_t        ats_ref_cnt;    /* number of VFs with ATS enabled */
#endif
#ifdef CONFIG_PCI_PRI
        u32             pri_reqs_alloc; /* Number of PRI requests allocated */
#endif
#ifdef CONFIG_PCI_PASID
        u16             pasid_features;
#endif
        phys_addr_t rom; /* Physical address of ROM if it's not from the BAR */
        size_t romlen; /* Length of ROM if it's not from the BAR */
        char *driver_override; /* Driver name to force a match */

        unsigned long priv_flags; /* Private flags for the pci driver */
};

```





## ÂèÇËÄÉ

[PCI‰∏éPCIeÂ≠¶‰π†‰∏Ä‚Äî‚ÄîÁ°¨‰ª∂ÁØá](https://blog.csdn.net/u013253075/article/details/80835489)