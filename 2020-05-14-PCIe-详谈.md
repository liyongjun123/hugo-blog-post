---
title: "PCIe è¯¦è°ˆ"
date: 2020-05-14T09:35:53+08:00
draft: false
categories: ["ç¡¬ä»¶"]
tags: ["ç»éªŒ","åè®®","æ€»çº¿"]
toc: "true"
url: "/2020/05/14/pcie-detail.html"
---



## æ˜¯ä»€ä¹ˆ

æ¥å£ã€æ€»çº¿



## å‡ºç°çš„è¿‡ç¨‹

- æ—©æœŸè®¡ç®—æœºä¸­å„ç§è®¾å¤‡ä½¿ç”¨çš„æ€»çº¿æ¥å£æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„
  - ç½‘å¡ç”¨ç€ç½‘å¡çš„æ¥å£
  - å£°å¡ç”¨è¿™å£°å¡çš„æ¥å£
  - æ˜¾å¡ç”¨ç€æ˜¾å¡çš„æ¥å£
- æ¥å£ä¸ç»Ÿä¸€ï¼Œä»¥åå‡çº§ä¹Ÿåªèƒ½ä½¿ç”¨ä¹‹å‰æ¥å£çš„å¤–è®¾ï¼Œæœ‰å¾ˆå¤§çš„å±€é™æ€§
- ä¸ºäº†è§£å†³è¿™ç§çŠ¶å†µ
  - IBM è”åˆ intel åˆ¶å®šäº†å¤§åé¼é¼çš„ ISA æ€»çº¿ï¼ˆç¬¬ä¸€ä»£æ€»çº¿ï¼‰
    - ä¸Šä¸–çºª 80 å¹´ä»£
    - å¹¶è¡Œæ€»çº¿
    - ç¼ºç‚¹
      - å¹¶è¡Œæ€»çº¿ï¼Œå½“æ—¶çš„æŠ—å¹²æ‰°æŠ€æœ¯ä¸æˆç†Ÿï¼Œé¢‘ç‡å°±æ— æ³•åšåˆ°å¾ˆé«˜ï¼Œå¸¦å®½ 8 MB/s
      - ä¸èƒ½å³æ’å³ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨å»åˆ†é…ç³»ç»Ÿèµ„æº
      - æœ€å¤§åªæ”¯æŒ 6 ä¸ªå¤–å›´è®¾å¤‡
  - PCI æ€»çº¿ï¼ˆç¬¬äºŒä»£æ€»çº¿ï¼‰
    - 132 MB/s
    - å³æ’å³ç”¨
    - ä¸ä¾èµ–äºå…·ä½“æŸæ¬¾ CPU çš„ç‹¬ç«‹æ€»çº¿
    - ç¼ºç‚¹
      - ä¾æ—§é‡‡ç”¨å¹¶è¡Œæ€»çº¿
      - å…±äº«æ€»çº¿ï¼Œé«˜è´Ÿè½½ä¸‹å¾ˆå¤šè®¾å¤‡ä¼šæŠ¢å¸¦å®½
      - ä¸æ”¯æŒçƒ­æ‹”æ’
  - PCIe æ€»çº¿ï¼ˆç¬¬ä¸‰ä»£æ€»çº¿ï¼Œgen3ï¼Œ3.0ï¼‰

## PCIe æœ‰ä¸¤ä¸ªå­˜åœ¨çš„å½¢æ€

- PCIe æ¥å£
  - PCIe æ’æ§½
    - å¯ä»¥æ’ PCIe æ¥å£çš„
      - æ˜¾å¡
      - ç½‘å¡
      - å›ºæ€ç¡¬ç›˜
      - æ— çº¿ç½‘å¡
      - æœ‰çº¿ç½‘å¡
      - é£Ÿè°±é‡‡é›†å¡
    - è¿˜å¯ä»¥æŠŠ PCIe æ¥å£è½¬æˆå…¶ä»–æ¥å£
      - PCIe è½¬ M.2
      - PCIe è½¬ USB
      - PCIe è½¬ Type-c
- PCIe é€šé“
  - æ¯”æ–¹è¯´ M.2å›ºæ€ç¡¬ç›˜è™½ç„¶æ¥å£çš„å½¢çŠ¶æ˜¯ M.2ï¼Œä½†æ˜¯æ•°æ®ä¼ è¾“ä¾èµ–çš„æ˜¯ PCIe é€šé“ï¼ŒPCIe åœ¨è¿™é‡Œå°±æ‰¿æ‹…æ•°æ®ä¼ è¾“æ€»çº¿çš„ä½œç”¨äº†ã€‚å› æ­¤å¯ä»¥ç®€å•çš„ç†è§£ M.2 å°±æ˜¯ä¸€ä¸ªæ¢äº†å½¢çŠ¶çš„ PCIe æ¥å£
  - é›·ç”µ3 ä¹Ÿæ˜¯åˆ©ç”¨ PCIe é€šé“æ¥ä¼ è¾“æ•°æ®çš„

## PCIe çš„å¸¦å®½

PCIe çš„å¸¦å®½æ˜¯æ ¹æ®æ¥å£çš„é•¿åº¦è®¡ç®—çš„

PCIe X1ã€PCIe X2ã€PCIe X4ã€PCIe X8ã€PCIe X16

![PCIe](/images/PCIe.png)

ä»»ä½• X16 çš„è®¾å¤‡éƒ½å¯ä»¥æ’åœ¨å°¾éƒ¨éé—­åˆçš„ X1 æ§½ä¸­è¿è¡Œï¼Œåªä¸è¿‡è¿™ä¸ªè®¾å¤‡è‚¯å®šæ˜¯æ— æ³•å‘æŒ¥å…¨éƒ¨çš„æ€§èƒ½äº†ã€‚

ä¹Ÿå¯ä»¥æŠŠ X1 çš„è®¾å¤‡æ’åœ¨ X16 çš„æ§½ä¸­è¿è¡Œï¼Œåªä¸è¿‡è¿™æ ·å°±æµªè´¹æ’æ§½å¸¦å®½äº†ã€‚

æ®‹è¡€ M.2 å’Œ é›·ç”µ3 è¯´çš„å°±æ˜¯ PCIe X2 é€Ÿç‡çš„ï¼›

æ»¡è¡€ M.2 å’Œ é›·ç”µ3 è¯´çš„å°±æ˜¯ PCIe X4 é€Ÿç‡çš„ã€‚

![PCIe é€Ÿç‡](/images/PCIeé€Ÿç‡.jpg)



## PCIe å¼•è„šå®šä¹‰

![img](/images/pcieå¼•è„šå®šä¹‰_1.jpg)

![img](/images/pcieå¼•è„šå®šä¹‰_2.jpg)

![img](/images/pcieå¼•è„šå®šä¹‰_3.jpg)

![img](/images/pcieå¼•è„šå®šä¹‰_4.jpg)

![img](/images/pcieå¼•è„šå®šä¹‰_5.jpg)

ä¸‹é¢è¿™ç¯‡æ–‡ç« çš„ååŠéƒ¨åˆ†æœ‰å¯¹ PCIe çš„æ”¹é€ å®éªŒï¼Œå€¼å¾—å­¦ä¹ 

[J1900è½¯è·¯ç”±åŠ è£…æ— çº¿ç½‘å¡åšAPæŠ˜è…¾è®°](https://www.jarviswang.me/?p=725)



## åè¯è§£é‡Š

Root Complex

RCï¼Œæ ¹è”åˆä½“ï¼Œæ ¹å¤åˆä½“



## å­¦ä¹ èµ·æ­¥

### 01. PCI-Express

https://blog.csdn.net/u013140088/category_7015733.html

### 02. PCIeåŸºç¡€çŸ¥è¯†

https://blog.csdn.net/zqixiao_09/article/details/51842542

### 03. PCIeæ€»çº¿åŸºæœ¬æ¦‚å¿µ

http://www.elecfans.com/d/664309.html

### 04. PCIeåº”ç”¨å®æˆ˜ ï¼ˆä»˜è´¹ï¼‰

https://blog.csdn.net/weiaipan1314/category_9722794.html?utm_source=ffzl_BWzd

### 05. Linux ä¸‹çš„ PCIE è®¾å¤‡é©±åŠ¨è®¾è®¡ä¸å®ç°

https://max.book118.com/html/2019/1026/6201155022002120.shtm

### 06. Linuxä¸‹PCIè®¾å¤‡é©±åŠ¨å¼€å‘è¯¦è§£

https://blog.csdn.net/weixin_42092278/article/details/81638530

### 07. mtk7621é©±åŠ¨

http://doc.okbase.net/22510743/archive/259892.html

### 08. rt3070 æ— çº¿ç½‘å¡ç§»æ¤

http://blog.chinaunix.net/uid-30407552-id-5182640.html

### 09. æ— çº¿é©±åŠ¨ç§»æ¤ä¸å¼€å‘-MTKæºç åˆ†æ

https://blog.csdn.net/u011212816/article/details/81137126

### 10. PCIeæ‰«ç›²

https://blog.csdn.net/kunkliu/category_9091238.html

### 11. ã€14ã€‘PCIeæ¶æ„ä¸‹memoryç©ºé—´ã€IOç©ºé—´ã€PCIeé…ç½®ç©ºé—´ç®€ä»‹

armç»Ÿä¸€ç¼–å€ï¼Œx86ç‹¬ç«‹ç¼–å€

https://blog.csdn.net/linjiasen/article/details/87944672

### 12. PCIeå­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰â€”â€”ç¡¬ä»¶è®¾å¤‡è¯†åˆ«æ‰«ç›²ç¯‡(å²æ— å‰ä¾‹çš„å¥½æ–‡ç« )

https://blog.csdn.net/codectq/article/details/104472150

### 13. Linuxé‚£äº›äº‹å„¿ ä¹‹ æˆ‘æ˜¯PCI

https://blog.csdn.net/fudan_abc/category_345294.html

### 14. ä¸€æ­¥ä¸€æ­¥å¼€å§‹FPGAé€»è¾‘è®¾è®¡ - é«˜é€Ÿæ¥å£ä¹‹PCIe

https://blog.csdn.net/jackxu8/article/details/53288385

### 15. PCIeæ‰«ç›²ç³»åˆ—åšæ–‡è¿è½½ç›®å½•ç¯‡

ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰http://blog.chinaaet.com/justlxy/p/5100053251

ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰http://blog.chinaaet.com/justlxy/p/5100053328

ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰http://blog.chinaaet.com/justlxy/p/5100053481

ï¼ˆç¬¬å››é˜¶æ®µï¼‰http://blog.chinaaet.com/justlxy/p/5100057779

ï¼ˆç¬¬äº”é˜¶æ®µï¼‰http://blog.chinaaet.com/justlxy/p/5100061871



### 1.1  PCIe æœ‰ link çš„æ¦‚å¿µ

link å¯ä»¥æœ‰ 1ã€2ã€4ã€8ã€16ã€32 æ¡ lane

![img](/images/pcie-link.png)

ä¸€æ¡ lane æ˜¯ç”±ä¸€ä¸ª transmitter å’Œ ä¸€ä¸ª receiver æ„æˆ

![img](/images/pcie-lane.png)

### 1.2  PCI é—®é¢˜

ä¸€ã€flight time

äºŒã€clock skew

ä¸‰ã€signal skew

### 1.3 PCIe è§£å†³

ä¸€ã€æ•°æ®æµä¸­åŒ…å«äº† clock,ä¸éœ€è¦å¤–åŠ  clockï¼Œæ‰€ä»¥ï¼Œæ— è®º clock å‘¨æœŸå¤šå°ï¼Œæˆ–è€…æ— è®ºä¿¡å·éœ€è¦å¤šé•¿çš„ä¼ æ’­æ—¶é—´ï¼Œéƒ½ä¸å­˜åœ¨ flight time è¿™ä¸ªé—®é¢˜

äºŒã€åŒæ ·ï¼Œå› ä¸ºæ²¡æœ‰å¤–éƒ¨ clockï¼Œå°±æ²¡æœ‰clock skew çš„é—®é¢˜

ä¸‰ã€å¯¹äºåªæœ‰ä¸€æ¡laneæ˜¯æ²¡æœ‰signal skweçš„é—®é¢˜ï¼Œä½†å¯¹äºå¤šæ¡laneï¼ŒPCIe ä¹Ÿæœ‰è§£å†³åŠæ³•

### 1.4 PCIe ä¿¡å·çº¿

~~PCIe â‰ˆ SPI(å»æ‰CS) + RS485~~

~~å³ï¼ŒPCIeåƒSPIä¸€æ ·ä½¿ç”¨åŒæ­¥æ—¶é’Ÿçº¿ï¼Œå…¨åŒå·¥ï¼›åƒRS485ä¸€æ ·ä½¿ç”¨å·®åˆ†ä¿¡å·ä¼ è¾“ã€‚PCIeçš„CLKã€Rxã€Txå‡ä½¿ç”¨å·®åˆ†ä¿¡å·ä¼ è¾“ã€‚ç‰›é€¼ğŸ®ï¼~~

### 1.5 PCIe æ‹“æ‰‘ç»“æ„

![pcieæ‹“æ‰‘ç»“æ„](/images/pcieæ‹“æ‰‘ç»“æ„.png)

### 1.6 PCIe æ˜¯ç‚¹å¯¹ç‚¹



### 4.1 PCIe å±‚çº§ç»“æ„

PCIe æ€»çº¿é‡‡ç”¨ä¸²è¡Œé€šä¿¡æ–¹å¼ï¼Œä½¿ç”¨æ•°æ®åŒ…(Packet)è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚

åœ¨PCIeæ€»çº¿ä¸­ï¼Œæ•°æ®æŠ¥æ–‡åœ¨æ¥æ”¶å’Œå‘é€è¿‡ç¨‹ä¸­ï¼Œéœ€è¦é€šè¿‡å¤šä¸ªå±‚æ¬¡ï¼ŒåŒ…æ‹¬äº‹åŠ¡å±‚(Transaction Layer)ã€æ•°æ®é“¾è·¯å±‚(Data Link Layer)ã€ç‰©ç†å±‚(Physical Layer)ã€‚

![img](/images/pcieå±‚çº§ç»“æ„.jpg)



### 4.2 TLP

Transaction Layer Packetã€‚

Host ä¸ PCIe è®¾å¤‡ä¹‹é—´ï¼Œæ•°æ®ä¼ è¾“éƒ½æ˜¯ä»¥ Packet å½¢å¼è¿›è¡Œçš„ï¼›

äº‹åŠ¡å±‚æ ¹æ®ä¸Šå±‚(è½¯ä»¶å±‚æˆ–è€…åº”ç”¨å±‚)è¯·æ±‚(Request)çš„ç±»å‹ã€ç›®çš„åœ°å€å’Œå…¶å®ƒç›¸å…³å±æ€§ï¼ŒæŠŠè¿™äº›è¯·æ±‚æ‰“åŒ…ï¼Œäº§ç”ŸTLPã€‚

ç„¶åè¿™äº›TLPå¾€ä¸‹ï¼Œç»å†æ•°æ®é“¾è·¯å±‚ã€ç‰©ç†å±‚ï¼Œæœ€ç»ˆè¾¾åˆ°ç›®æ ‡è®¾å¤‡ã€‚

æ¯ä¸ªäº‹ç‰©éƒ½è¦é€šè¿‡ä¸€ä¸ªæˆ–è€…å¤šä¸ªTLPåŒ…å®ç°ã€‚

TLPä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Dataã€CRC ã€‚

TLPç”Ÿäºå‘é€ç«¯çš„äº‹åŠ¡å±‚ï¼Œç»ˆäºæ¥æ”¶ç«¯çš„äº‹åŠ¡å±‚ã€‚

#### 4.2.1 TLP Header

TLP Header é•¿ 3ã€4 ä¸ª DWã€‚

åŒ…æ‹¬å‘é€è€…çš„å„ç§ç›¸å…³ä¿¡æ¯ï¼Œç›®æ ‡åœ°å€(è¯¥TLPè¦ç»™è°)ã€TLPç±»å‹(Memory readï¼ŒMemory writeç­‰)ã€æ•°æ®é•¿åº¦(å¦‚æœæœ‰çš„è¯)ç­‰ç­‰ã€‚

![img](/images/TLP_Header.jpg)

ç¬¬1ä¸ªåŒå­—æ˜¯æ‰€æœ‰ç±»å‹çš„TLPéƒ½æœ‰çš„ï¼›åé¢çš„3ä¸ªåŒå­—æ ¹æ® Fmtã€Typeå±æ€§æ”¹å˜ã€‚

![img](/images/TLP_Header_Fmt_Type.jpg)

#### 4.2.2 TLP Data

å³ TLP çš„ PayloadåŸŸï¼Œç”¨æ¥æ”¾æœ‰æ•ˆè½½è·æ•°æ®ã€‚è¯¥åŸŸä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ª TLP éƒ½å¿…é¡»æºå¸¦æ•°æ®çš„ï¼Œæ¯”å¦‚ Memory Read TLPï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œæ•°æ®æ˜¯ç”±ç›®æ ‡è®¾å¤‡é€šè¿‡ Completion TLP è¿”å›çš„ã€‚

ä¸€ä¸ª TLP æœ€å¤§è½½é‡æ˜¯4KBï¼Œæ•°æ®é•¿åº¦å¤§äº4KBçš„è¯ï¼Œå°±éœ€è¦åˆ†å‡ ä¸ªTLPä¼ è¾“ã€‚

#### 4.2.3 CRC

å¯¹ Header å’Œ Data ç”Ÿæˆä¸€ä¸ª CRCã€‚

å®ƒæ˜¯å¯é€‰çš„ï¼Œå¯ä»¥è®¾ç½®ä¸åŠ  CRCã€‚

### 4.3 PCIe é…ç½®ç©ºé—´

æ¯ä¸ª PCIe è®¾å¤‡ï¼Œéƒ½æœ‰è¿™ä¹ˆä¸€æ®µç©ºé—´ï¼ŒHost è½¯ä»¶å¯ä»¥è¯»å–å®ƒè·å¾—è¯¥è®¾å¤‡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®ƒæ¥é…ç½®è¯¥è®¾å¤‡ï¼Œè¿™æ®µæ‰£å‡å°±å«åš PCIe çš„é…ç½®ç©ºé—´ã€‚

PCIe æœ‰ä¸¤ç§ç±»å‹çš„é…ç½®ç©ºé—´ï¼ŒType0 å’Œ Type1ï¼Œåˆ†åˆ«å¯¹åº”ç«¯ç‚¹è®¾å¤‡(Endpoint)å’Œæ¡¥è®¾å¤‡(Rootå’ŒSwitchç«¯å£ä¸­çš„P2Pæ¡¥)ï¼Œæˆ‘ä»¬åªè®¨è®ºç«¯ç‚¹è®¾å¤‡çš„é…ç½®ç©ºé—´å…·ä½“å±æ€§ã€‚

### 4.4 PCIe ç©ºé—´

PCIeå†…éƒ¨æœ‰é…ç½®ç©ºé—´ã€memoryç©ºé—´ã€IOç©ºé—´(ä¸è®¨è®ºï¼Œæš‚ä¸ç”¨)ã€‚

å¤„ç†å™¨è®¿é—®è¿™äº›ç©ºé—´éƒ½æ˜¯åœ¨å¼€æœºçš„æ—¶å€™æå‰è¿›è¡Œäº†åœ°å€æ˜ å°„ã€‚

å¤„ç†å™¨è®¿é—®é…ç½®ç©ºé—´è·å¾—è®¾å¤‡çš„çŠ¶æ€å’Œè®¾å¤‡å±æ€§ä¿¡æ¯ï¼Œå¤„ç†å™¨è®¿é—®memoryç©ºé—´å¯ä»¥å’ŒPCIeè®¾å¤‡è¿›è¡Œæ•°æ®äº¤äº’ã€‚

### 4.5 BARå¯„å­˜å™¨å’ŒBARç©ºé—´

BARå¯„å­˜å™¨åœ¨PCIeé…ç½®ç©ºé—´é‡Œé¢ï¼Œä¸€ä¸ªPCIeè®¾å¤‡ï¼Œå¯èƒ½æœ‰è‹¥å¹²ä¸ªå†…éƒ¨ç©ºé—´(æœ€å¤š6ä¸ª)éœ€è¦æ˜ å°„åˆ°**ä¸»æœºmemory**åœ°å€ç©ºé—´ï¼Œè®¾å¤‡å‡ºå‚æ—¶ï¼Œè¿™äº›ç©ºé—´çš„å¤§å°å’Œå±æ€§éƒ½å†™åœ¨



#### 5.1 PCIe è®¾å¤‡é©±åŠ¨

~~PCIe æ€»çº¿ä¸Šçš„å„ç§å¤–è®¾é©±åŠ¨å¯ä»¥çœ‹ä½œæ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨ã€‚~~

PCIe è®¾å¤‡é©±åŠ¨ï¼šLinux å†…æ ¸çš„ PCIe è®¾å¤‡é©±åŠ¨ + æ€»çº¿ä¸Šæ‰€è½½è®¾å¤‡æœ¬èº«çš„é©±åŠ¨ã€‚

å‰è€…ä¸éœ€è¦æˆ‘ä»¬å»å®ç°ï¼Œä¹Ÿå¾ˆéš¾å®ç°

#### 5.2 Intel

PCIe ç”±Intelæå‡ºï¼Œé«˜é€Ÿä¸²è¡Œç‚¹å¯¹ç‚¹ï¼Œç‹¬äº«é€šé“å¸¦å®½ã€‚

#### 5.3 /dev

/dev ä¸­æ”¾çš„éƒ½æ˜¯å­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡ï¼Œç½‘ç»œè®¾å¤‡å¹¶ä¸å±äºæ­¤äºŒç±»ï¼Œæ— æ³•å®ç°å®ƒä»¬çš„æ¥å£ã€‚ [ğŸ”—](https://forum.ubuntu.org.cn/viewtopic.php?p=3057815)

![Linuxè®¾å¤‡é©±åŠ¨ä¸æ•´ä¸ªè½¯ç¡¬ä»¶ç³»ç»Ÿçš„å…³ç³»](/images/Linuxè®¾å¤‡é©±åŠ¨ä¸æ•´ä¸ªè½¯ç¡¬ä»¶ç³»ç»Ÿçš„å…³ç³».png)

ç½‘ç»œè®¾å¤‡å¹¶æ²¡æœ‰è´¯å½»â€œä¸€åˆ‡çš†æ–‡ä»¶â€œçš„æ€æƒ³ï¼Œç½‘ç»œè®¾å¤‡ä¸ä»¥/devä¸‹çš„è®¾å¤‡æ–‡ä»¶ä¸ºæ¥å£ï¼Œ**ç”¨æˆ·ç¨‹åºé€šè¿‡socketä½œä¸ºè®¿é—®ç¡¬ä»¶çš„æ¥å£**ã€‚[ğŸ”—](https://www.cnblogs.com/xiaojiang1025/p/6486267.html)



#### 6.1 PCI è®¾å¤‡é©±åŠ¨ç»„æˆ

PCIæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§æ€»çº¿ï¼Œå…·ä½“çš„PCIè®¾å¤‡å¯ä»¥æ˜¯å­—ç¬¦è®¾å¤‡ã€ç½‘ç»œè®¾å¤‡ã€USBè®¾å¤‡ç­‰ï¼Œæ‰€ä»¥PCIè®¾å¤‡é©±åŠ¨åº”è¯¥åŒ…å«ä¸¤éƒ¨åˆ†

1. PCI é©±åŠ¨
2. æ ¹æ®éœ€æ±‚çš„è®¾å¤‡é©±åŠ¨

æ ¹æ®éœ€æ±‚çš„è®¾å¤‡é©±åŠ¨æ˜¯æœ€ç»ˆç›®çš„ï¼ŒPCIé©±åŠ¨åªæ˜¯æ‰‹æ®µå¸®åŠ©éœ€æ±‚è®¾å¤‡é©±åŠ¨è¾¾åˆ°æœ€ç»ˆç›®çš„è€Œå·²ã€‚æ¢å¥è¯è¯´PCIè®¾å¤‡é©±åŠ¨ä¸ä»…è¦å®ç°PCIé©±åŠ¨ï¼Œè¿˜è¦å®ç°æ ¹æ®éœ€æ±‚çš„è®¾å¤‡é©±åŠ¨ã€‚

![PCIè®¾å¤‡é©±åŠ¨](/images/PCIè®¾å¤‡é©±åŠ¨.png)



#### 7.1 PCI ä¸‰ç§åœ°å€ç©ºé—´

PCI è®¾å¤‡ä¸Šç”±ä¸‰ç§åœ°å€ç©ºé—´ï¼šPCIçš„I/Oç©ºé—´ã€PCIçš„å­˜å‚¨ç©ºé—´ã€PCIçš„é…ç½®ç©ºé—´ã€‚

CPUå¯ä»¥è®¿é—®PCIè®¾å¤‡ä¸Šçš„æ‰€æœ‰åœ°å€ç©ºé—´ã€‚å…¶ä¸­I/Oç©ºé—´å’Œå­˜å‚¨ç©ºé—´æä¾›ç»™è®¾å¤‡é©±åŠ¨ç¨‹åºä½¿ç”¨ï¼Œè€Œé…ç½®ç©ºé—´åˆ™ç”±Linuxå†…æ ¸ä¸­çš„PCIåˆå§‹åŒ–ä»£ç ä½¿ç”¨ã€‚å†…æ ¸åœ¨å¯åŠ¨æ—¶è´Ÿè´£å¯¹æ‰€æœ‰PCIè®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œé…ç½®å¥½æ‰€æœ‰çš„PCIè®¾å¤‡ï¼ŒåŒ…æ‹¬ä¸­æ–­å·ä»¥åŠI/OåŸºå€ï¼Œå¹¶åœ¨æ–‡ä»¶` /proc/pci ` ? ` /proc/bus/pci `ä¸­åˆ—å‡ºæ‰€æœ‰æ‰¾åˆ°çš„PCIè®¾å¤‡ï¼Œä»¥åŠè¿™äº›è®¾å¤‡çš„å‚æ•°å’Œå±æ€§ã€‚

#### 7.2 é©±åŠ¨ä¸­çš„ struct

Linux é©±åŠ¨ç¨‹åºé€šå¸¸ä½¿ç”¨ç»“æ„ä½“(struct)æ¥è¡¨ç¤ºä¸€ç§è®¾å¤‡ï¼Œè€Œç»“æ„ä½“å˜é‡åˆ™ä»£è¡¨ä¸€å…·ä½“è®¾å¤‡ï¼Œè¯¥å˜é‡å­˜æ”¾äº†ä¸è¯¥è®¾å¤‡ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ã€‚å¥½çš„é©±åŠ¨ç¨‹åºéƒ½åº”è¯¥èƒ½é©±åŠ¨å¤šä¸ªåŒç§è®¾å¤‡ï¼Œæ¯ä¸ªè®¾å¤‡ä¹‹é—´ç”¨æ¬¡è®¾å¤‡å·è¿›è¡ŒåŒºåˆ†ï¼Œæ¬¡è®¾å¤‡å·ç­‰ä»·äºç»“æ„ä½“æ•°ç»„ä¸‹æ ‡ã€‚



#### 14.1 é…ç½®ç©ºé—´















## ä»£ç 

hello_pcie.c

### 1

```c
// #define DMA_BUFFER_SIZE 1*1024*1024 
#define DMA_BUFFER_SIZE 512
```



### 2

```c
/*
 * The pci_dev structure is used to describe PCI devices.
 */
struct pci_dev {
    	// æ€»çº¿è®¾å¤‡é“¾è¡¨å…ƒç´ bus_listï¼šæ¯ä¸ª pci_dev ç»“æ„é™¤äº†é“¾æ¥åˆ°å…¨å±€è®¾å¤‡é“¾è¡¨ä¸­å¤–ï¼Œ
    	// è¿˜ä¼šé€šè¿‡è¿™ä¸ªæˆå‘˜é“¾æ¥åˆ°å…¶æ‰€å± PCI æ€»çº¿çš„è®¾å¤‡é“¾è¡¨ä¸­ã€‚
    	// æ¯ä¸€æ¡ PCI æ€»çº¿ï¼Œéƒ½ç»´æŠ¤ä¸€æ¡å®ƒè‡ªå·±çš„è®¾å¤‡é“¾è¡¨è§†å›¾ï¼Œä»¥ä¾¿æè¿°æ‰€æœ‰è¿æ¥åœ¨è¯¥PCIæ€»çº¿ä¸Šçš„è®¾å¤‡ã€‚
    	// å…¶è¡¨å¤´ç”±PCIæ€»çº¿çš„pci_busç»“æ„ä¸­çš„ devices æˆå‘˜æ‰€æè¿°
        struct list_head bus_list;      /* node in per-bus list */	
    	// æ€»çº¿æŒ‡é’ˆbusï¼šæŒ‡å‘è¿™ä¸ª PCI è®¾å¤‡æ‰€åœ¨çš„ PCI æ€»çº¿çš„ pci_bus ç»“æ„ã€‚
    	// å› æ­¤å¯¹äºæ¡¥è®¾å¤‡è€Œè¨€ï¼Œbus æŒ‡é’ˆå°†æŒ‡å‘æ¡¥è®¾å¤‡çš„ä¸»æ€»çº¿(primay bus)ï¼Œä¹Ÿå³æŒ‡å‘æ¡¥è®¾å¤‡æ‰€åœ¨çš„PCIæ€»çº¿
        struct pci_bus  *bus;           /* bus this device is on */
    	// æŒ‡é’ˆsubordinateï¼šæŒ‡å‘è¿™ä¸ª PCI è®¾å¤‡æ‰€æ¡¥æ¥çš„ä¸‹çº§æ€»çº¿ã€‚
    	// è¿™ä¸ªæŒ‡é’ˆæˆå‘˜ä»…å¯¹æ¡¥æ¥è®¾å¤‡æ‰æœ‰æ„ä¹‰ï¼Œè€Œå¯¹ä¸€èˆ¬éæ¡¥PCIè®¾å¤‡è€Œè¨€ï¼Œè¯¥æŒ‡é’ˆæˆå‘˜æ€»æ˜¯ä¸ºNULL
        struct pci_bus  *subordinate;   /* bus this device bridges to */

    	// æ— ç±»å‹æŒ‡é’ˆ sysdataï¼šæŒ‡å‘ä¸€ç‰‡å¾…å®šäºç³»ç»Ÿçš„æ‰©å±•æ•°æ®
        void            *sysdata;       /* hook for sys-specific extension */
    
    	// æŒ‡å‘è¯¥ PCI è®¾å¤‡åœ¨ /proc æ–‡ä»¶ç³»ç»Ÿä¸­å¯¹åº”çš„ç›®å½•é¡¹
        struct proc_dir_entry *procent; /* device entry in /proc/bus/pci */
        struct pci_slot *slot;          /* Physical slot this device is in */

    	// PCI è®¾å¤‡çš„è®¾å¤‡åŠŸèƒ½å·
        unsigned int    devfn;          /* encoded device & function index */
    	// 16ä½æ— ç¬¦å·æ•´æ•°ï¼Œè¡¨ç¤º PCI è®¾å¤‡çš„å‚å•†ID
        unsigned short  vendor;
    	// 16ä½æ— ç¬¦å·æ•´æ•°ï¼Œè¡¨ç¤º PCI è®¾å¤‡çš„è®¾å¤‡ID
        unsigned short  device;
        unsigned short  subsystem_vendor;
        unsigned short  subsystem_device;
    	// 32ä½æ— ç¬¦å·æ•´æ•°ï¼Œè¡¨ç¤ºè¯¥ PCI è®¾å¤‡çš„ç±»åˆ«ï¼Œ
    	// å…¶ä¸­ï¼Œbitï¼»7ï¼š0ï¼½ä¸ºç¼–ç¨‹æ¥å£ï¼Œbitï¼»15ï¼š8ï¼½ä¸ºå­ç±»åˆ«ä»£ç ï¼Œbit ï¼»23ï¼š16ï¼½ä¸ºåŸºç±»åˆ«ä»£ç ï¼Œ
    	// bitï¼»31ï¼š24ï¼½æ— æ„ä¹‰ã€‚æ˜¾ç„¶ï¼Œclassæˆå‘˜çš„ä½3å­—èŠ‚åˆšå¥½å¯¹åº”ä¸PCIé…ç½®ç©ºé—´ä¸­çš„ç±»ä»£ç 
        unsigned int    class;          /* 3 bytes: (base,sub,prog-if) */
        u8              revision;       /* PCI revision, low byte of class word */
        u8              hdr_type;       /* PCI header type (`multi' flag masked out) */
#ifdef CONFIG_PCIEAER
        u16             aer_cap;        /* AER capability offset */
#endif
        u8              pcie_cap;       /* PCIe capability offset */
        u8              msi_cap;        /* MSI capability offset */
        u8              msix_cap;       /* MSI-X capability offset */
        u8              pcie_mpss:3;    /* PCIe Max Payload Size Supported */
        u8              rom_base_reg;   /* which config register controls the ROM */
        u8              pin;            /* which interrupt pin this device uses */
        u16             pcie_flags_reg; /* cached PCIe Capabilities Register */
        unsigned long   *dma_alias_mask;/* mask of enabled devfn aliases */

    	// æŒ‡å‘è¿™ä¸ª PCI è®¾å¤‡æ‰€å¯¹åº”çš„é©±åŠ¨ç¨‹åºå®šä¹‰çš„ pci_driver ç»“æ„ã€‚æ¯ä¸€ä¸ªpciè®¾å¤‡é©±åŠ¨ç¨‹åºéƒ½
    	// å¿…é¡»å®šä¹‰å®ƒè‡ªå·±çš„ pci_driver ç»“æ„æ¥æè¿°å®ƒè‡ªå·±
        struct pci_driver *driver;      /* which driver has allocated this device */
        
    	// ç”¨äº DMA çš„æ€»çº¿åœ°å€æ©ç ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæˆå‘˜çš„å€¼æ˜¯ 0xffffffff
    	u64             dma_mask;       /* Mask of the bits of bus address this
                                           device implements.  Normally this is
                                           0xffffffff.  You only need to change
                                           this if your device has broken DMA
                                           or supports 64-bit transfers.  */

        struct device_dma_parameters dma_parms;
    
    	// å½“å‰æ“ä½œçŠ¶æ€
        pci_power_t     current_state;  /* Current operating state. In ACPI-speak,
                                           this is D0-D3, D0 being fully functional,
                                           and D3 being off. */
        u8              pm_cap;         /* PM capability offset */
        unsigned int    pme_support:5;  /* Bitmask of states from which PME#
                                           can be generated */
        unsigned int    pme_poll:1;     /* Poll device's PME status bit */
        unsigned int    d1_support:1;   /* Low power state D1 is supported */
        unsigned int    d2_support:1;   /* Low power state D2 is supported */
        unsigned int    no_d1d2:1;      /* D1 and D2 are forbidden */
        unsigned int    no_d3cold:1;    /* D3cold is forbidden */
        unsigned int    bridge_d3:1;    /* Allow D3 for bridge */
        unsigned int    d3cold_allowed:1;       /* D3cold is allowed by user */
        unsigned int    mmio_always_on:1;       /* disallow turning off io/mem
                                                   decoding during bar sizing */
        unsigned int    wakeup_prepared:1;
        unsigned int    runtime_d3cold:1;       /* whether go through runtime
                                                   D3cold, not set for devices
                                                   powered on/off by the
                                                   corresponding bridge */
        unsigned int    skip_bus_pm:1;  /* Internal: Skip bus-level PM */
        unsigned int    ignore_hotplug:1;       /* Ignore hotplug events */
        unsigned int    hotplug_user_indicators:1; /* SlotCtl indicators
                                                      controlled exclusively by
                                                      user sysfs */
        unsigned int    clear_retrain_link:1;   /* Need to clear Retrain Link
                                                   bit manually */
        unsigned int    d3_delay;       /* D3->D0 transition time in ms */
        unsigned int    d3cold_delay;   /* D3cold->D0 transition time in ms */

#ifdef CONFIG_PCIEASPM
        struct pcie_link_state  *link_state;    /* ASPM link state */
        unsigned int    ltr_path:1;     /* Latency Tolerance Reporting
                                           supported from root to here */
#endif

        pci_channel_state_t error_state;        /* current connectivity state */
        struct  device  dev;            /* Generic device interface */

    	// é…ç½®ç©ºé—´çš„å¤§å°
        int             cfg_size;       /* Size of configuration space */
        /*
         * Instead of touching interrupt line and base address registers
         * directly, use the values stored here. They might be different!
         */
        unsigned int    irq;
        struct resource resource[DEVICE_COUNT_RESOURCE]; /* I/O and memory regions + expansion ROMs */

        bool match_driver;              /* Skip attaching driver */
        /* These fields are used by common fixups */
        unsigned int    transparent:1;  /* Subtractive decode PCI bridge */
        unsigned int    multifunction:1;/* Part of multi-function device */
        /* keep track of device state */
        unsigned int    is_added:1;
        unsigned int    is_busmaster:1; /* device is busmaster */
        unsigned int    no_msi:1;       /* device may not use msi */
        unsigned int    no_64bit_msi:1; /* device may only use 32-bit MSIs */
        unsigned int    block_cfg_access:1;     /* config space access is blocked */
        unsigned int    broken_parity_status:1; /* Device generates false positive parity */
        unsigned int    irq_reroute_variant:2;  /* device needs IRQ rerouting variant */
        unsigned int    msi_enabled:1;
        unsigned int    msix_enabled:1;
        unsigned int    ari_enabled:1;  /* ARI forwarding */
        unsigned int    ats_enabled:1;  /* Address Translation Service */
        unsigned int    pasid_enabled:1;        /* Process Address Space ID */
        unsigned int    pri_enabled:1;          /* Page Request Interface */
        unsigned int    is_managed:1;
        unsigned int    needs_freset:1; /* Dev requires fundamental reset */
        unsigned int    state_saved:1;
        unsigned int    is_physfn:1;
        unsigned int    is_virtfn:1;
        unsigned int    reset_fn:1;
        unsigned int    is_hotplug_bridge:1;
        unsigned int    is_thunderbolt:1; /* Thunderbolt controller */
        /*
         * Devices marked being untrusted are the ones that can potentially
         * execute DMA attacks and similar. They are typically connected
         * through external ports such as Thunderbolt but not limited to
         * that. When an IOMMU is enabled they should be getting full
         * mappings to make sure they cannot access arbitrary memory.
         */
        unsigned int    untrusted:1;
        unsigned int    __aer_firmware_first_valid:1;
        unsigned int    __aer_firmware_first:1;
        unsigned int    broken_intx_masking:1; /* INTx masking can't be used */
        unsigned int    io_window_1k:1; /* Intel P2P bridge 1K I/O windows */
        unsigned int    irq_managed:1;
        unsigned int    has_secondary_link:1;
        unsigned int    non_compliant_bars:1;   /* broken BARs; ignore them */
        unsigned int    is_probed:1;            /* device probing in progress */
        pci_dev_flags_t dev_flags;
        atomic_t        enable_cnt;     /* pci_enable_device has been called */

        u32             saved_config_space[16]; /* config space saved at suspend time */
        struct hlist_head saved_cap_space;
        struct bin_attribute *rom_attr; /* attribute descriptor for sysfs ROM entry */
        int rom_attr_enabled;           /* has display of the rom attribute been enabled? */
        struct bin_attribute *res_attr[DEVICE_COUNT_RESOURCE]; /* sysfs file for resources */
        struct bin_attribute *res_attr_wc[DEVICE_COUNT_RESOURCE]; /* sysfs file for WC mapping of resources */

#ifdef CONFIG_PCIE_PTM
        unsigned int    ptm_root:1;
        unsigned int    ptm_enabled:1;
        u8              ptm_granularity;
#endif
#ifdef CONFIG_PCI_MSI
        const struct attribute_group **msi_irq_groups;
#endif
        struct pci_vpd *vpd;
#ifdef CONFIG_PCI_ATS
        union {
                struct pci_sriov *sriov;        /* SR-IOV capability related */
                struct pci_dev *physfn; /* the PF this VF is associated with */
        };
        u16             ats_cap;        /* ATS Capability offset */
        u8              ats_stu;        /* ATS Smallest Translation Unit */
        atomic_t        ats_ref_cnt;    /* number of VFs with ATS enabled */
#endif
#ifdef CONFIG_PCI_PRI
        u32             pri_reqs_alloc; /* Number of PRI requests allocated */
#endif
#ifdef CONFIG_PCI_PASID
        u16             pasid_features;
#endif
        phys_addr_t rom; /* Physical address of ROM if it's not from the BAR */
        size_t romlen; /* Length of ROM if it's not from the BAR */
        char *driver_override; /* Driver name to force a match */

        unsigned long priv_flags; /* Private flags for the pci driver */
};

```





## ç”¨å›¾è¯´è¯

1. ä¸€ä¸ªå…¸å‹çš„33MHzçš„PCIæ€»çº¿ç³»ç»Ÿå›¾

![img](/images/PCIæ€»çº¿.png)

2. PCIæ€»çº¿æ˜¯ä¸€ç§å…±äº«æ€»çº¿ï¼Œæ‰€ä»¥éœ€è¦ä»²è£å™¨(Arbiter)æ¥å†³å®šå½“å‰æ—¶åˆ»çš„æ€»çº¿æ§åˆ¶æƒï¼Œä¸€èˆ¬è¯¥ä»²è£å™¨ä½äºåŒ—æ¡¥ä¸­ã€‚ä»²è£å™¨ï¼ˆä¸»æœºï¼‰é€šè¿‡ä¸€å¯¹å¼•è„šï¼ŒREQï¼ˆrequestï¼‰å’Œ GNTï¼ˆgrantï¼‰æ¥ä¸å„ä¸ªä»æœºè¿æ¥ã€‚

![img](/images/PCIæ€»çº¿ä»²è£å™¨.png)



3. éšç€ç‰ˆæœ¬æ›´æ–°ï¼Œæ—¶é’Ÿé¢‘ç‡é€æ¸æé«˜ï¼Œå¯¼è‡´æ€»çº¿çš„æœ€å¤§è´Ÿè½½è¶Šæ¥è¶Šå°‘ï¼Œæœ€ååªèƒ½æ’ä¸€ä¸ªPCIå¡äº†ã€‚

![img](/images/PCIæ—¶é’Ÿé¢‘ç‡ä¸æœ€å¤§è´Ÿè½½ä¸ªæ•°.png)

4. æ¯ä¸ªLinkæ”¯æŒ1ï½32ä¸ªé€šé“(Lane)

![img](/images/Link.png)

5. ä¸€ä¸ª Lane

![img](/images/PCIe-Lane.png)

6. PCIeæ€»çº¿ç³»ç»Ÿçš„æ‹“æ‰‘ç»“æ„ã€‚

![img](/images/PCIeæ€»çº¿æ‹“æ‰‘ç»“æ„.png)



7. PCIæ€»çº¿çš„åœ°å€ç©ºé—´åˆ†é…ã€‚
   1. PCIä¸€å…±æ”¯æŒä¸‰ç§åœ°å€ç©ºé—´ï¼šMemory Address Spaceã€I/O Address Spaceã€Configuration Address Spaceã€‚å…¶ä¸­x86å¤„ç†å™¨å¯ä»¥ç›´æ¥è®¿é—®çš„åªæœ‰ Memory Address Space å’Œ I/O Address Spaceã€‚è€Œè®¿é—® Configuration Address Space åˆ™éœ€è¦é€šè¿‡ç´¢å¼• I/O å¯„å­˜å™¨æ¥å®Œæˆã€‚
   2. æ³¨ï¼šåœ¨PCIeä¸­ï¼Œåˆ™å¼•å…¥äº†ä¸€ç§æ–°çš„Configuration Address Space è®¿é—®æ–¹å¼ï¼šå°†å…¶ç›´æ¥æ˜ å°„åˆ°äº†Memory Address Space å½“ä¸­ã€‚

![img](/images/PCIé…ç½®ç©ºé—´æ˜ å°„.png)





8. PCIæ€»çº¿å…·æœ‰32ä½æ•°æ®/åœ°å€å¤ç”¨æ€»çº¿ï¼Œæ‰€ä»¥å…¶åœ°å€ç©ºé—´ä½2çš„32æ¬¡æ–¹=4GBã€‚ä¹Ÿå°±æ˜¯PCIä¸Šçš„æ‰€æœ‰è®¾å¤‡å…±åŒæ˜ å°„åˆ°è¿™4GBä¸Šï¼Œæ¯ä¸ªPCIè®¾å¤‡å ç”¨å”¯ä¸€çš„ä¸€æ®µPCIåœ°å€ï¼Œä»¥ä¾¿PCIæ€»çº¿ç»Ÿä¸€å¯»å€ã€‚æ¯ä¸ªPCIè®¾å¤‡é€šè¿‡PCIå¯„å­˜å™¨ä¸­çš„åŸºåœ°å€å¯„å­˜å™¨æ¥åˆ¶å®šæ˜ å°„çš„é¦–åœ°å€ã€‚PCIåœ°å€ç©ºé—´å¯¹åº”äºè®¡ç®—æœºç³»ç»Ÿç»“æ„ä¸­çš„PCIæ€»çº¿ã€‚

![PCIåœ°å€ç©ºé—´](/images/PCIåœ°å€ç©ºé—´.jpg)

9. å¦‚æœå¤„ç†å™¨å…·æœ‰32ä½çš„åœ°å€æ€»çº¿ï¼Œå…¶ç†è®ºå¯å¯»å€ç©ºé—´ä½2çš„32æ¬¡æ–¹=4GBã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€å†…å­˜å°±å¯ä»¥4GBå¤§å°ï¼Œå…¶å®XPç³»ç»Ÿæœ€å¤§å†…å­˜çº¦ä¸º2GBã€‚CPUæŠŠç³»ç»Ÿä¸­å„ä¸ªè®¾å¤‡çš„å­˜å‚¨ç©ºé—´æ˜ å°„åˆ°ä¸€ä¸ªç»Ÿä¸€çš„å­˜å‚¨ç©ºé—´ï¼Œæˆä¸ºç³»ç»Ÿå­˜å‚¨ç©ºé—´å…±4GBï¼Œè¿™æ ·CPUå°±å¯ä»¥è®¿é—®åˆ°æ‰€æœ‰çš„å­˜å‚¨å™¨ã€‚æ¯”å¦‚PCIå­˜å‚¨å™¨æ˜ å°„åˆ°ä»0xFFF80000å¼€å§‹çš„åœ°å€ç©ºé—´ï¼Œæ˜¾å¡æ˜ å°„åˆ°0XFFF00000ï¼Œå†åŠ ä¸Šæ“ä½œç³»ç»Ÿä¼šå ç”¨ä¸€äº›ç©ºé—´ï¼Œå°±åªå‰©ä¸‹ä¸åˆ°2Gèƒ½çœŸæ­£åˆ†é…ç»™ç‰©ç†å†…å­˜äº†ã€‚

![ç³»ç»Ÿåœ°å€ç©ºé—´ä¸PCIåœ°å€ç©ºé—´](/images/ç³»ç»Ÿåœ°å€ç©ºé—´ä¸PCIåœ°å€ç©ºé—´.jpg)

10. PCIeæ€»çº¿åœ¨è½¯ä»¶ä¸Šæ˜¯å‘å‰å…¼å®¹PCIæ€»çº¿çš„ã€‚å› æ­¤PCIeæ€»çº¿å®Œæ•´çš„ç»§æ‰¿äº†PCIæ€»çº¿ä¸­çš„é…ç½®ç©ºé—´å¤´ï¼ˆConfiguration Space Headerï¼‰çš„æ¦‚å¿µã€‚åœ¨PCIeæ€»çº¿ä¸­ä¹Ÿæœ‰ä¸¤ç§Headerï¼ŒHeader0å’ŒHeader1ï¼Œåˆ†åˆ«ä»£è¡¨éæ¡¥è®¾å¤‡(Endpoint)å’Œæ¡¥è®¾å¤‡ï¼Œè¿™ä¸PCIæ€»çº¿æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚

![img](/images/PCIeç»§æ‰¿PCIé…ç½®ç©ºé—´.png)



11. Root Complex å’Œ Switch éƒ½æ˜¯å…¨æ–°çš„PCIeæ¦‚å¿µã€‚ï¼ˆæ³¨ï¼šRoot Complex ç»å¸¸è¢«ç§°ä¸ºRCæˆ–è€…Rootï¼‰
    1. ä»–ä»¬ç»“æ„ä¸­çš„æ¯ä¸€ä¸ªç«¯å£(Port)éƒ½å¯ä»¥**å¯¹åº”äº**PCIæ€»çº¿ä¸­çš„PCI-to-PCIæ¡¥çš„æ¦‚å¿µã€‚
    2. ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªRCå’ŒSwitchä¸­ä¸€èˆ¬éƒ½æœ‰å¤šä¸ª**ç±»ä¼¼äº**PCI-to-PCIæ¡¥çš„ä¸œè¥¿ã€‚åˆ†åˆ«å¦‚ä¸‹ä¸¤å¼ å›¾æ‰€ç¤ºï¼š

![img](/images/PCIe-RC.png)

![img](/images/PCIe-Switch.png)

12. ä¸€ä¸ªå…¸å‹çš„æœåŠ¡å™¨PCIeæ€»çº¿ç³»ç»Ÿçš„æ‹“æ‰‘ç»“æ„

![æœåŠ¡å™¨PCIeæ‹“æ‰‘ç»“æ„](/images/æœåŠ¡å™¨PCIeæ‹“æ‰‘ç»“æ„.png)

13. ä¸€ä¸ªå…¸å‹çš„PCçš„PCIeæ€»çº¿ç³»ç»Ÿçš„æ‹“æ‰‘ç»“æ„

![img](/images/PCçš„PCIeæ‹“æ‰‘ç»“æ„.png)

14. å’Œå¾ˆå¤šä¸²è¡Œä¼ è¾“åè®®ä¸€æ ·ï¼Œä¸€ä¸ªå®Œæ•´çš„PCIeä½“ç³»ç»“æ„åŒ…æ‹¬åº”ç”¨å±‚ã€äº‹ç‰©å±‚(Transaction Layer)ã€æ•°æ®é“¾è·¯å±‚(Data Link Layer)å’Œç‰©ç†å±‚(Physical Layer)ã€‚å…¶ä¸­ï¼Œåº”ç”¨å±‚å¹¶ä¸æ˜¯PCIeæ‰€è§„å®šçš„å†…å®¹ï¼Œå®Œå…¨ç”±ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œè®¾è®¡ï¼Œå¦å¤–ä¸‰å±‚éƒ½æ˜¯PCIe Specæ˜ç¡®è§„èŒƒçš„ï¼Œå¹¶è¦æ±‚è®¾è®¡è€…ä¸¥æ ¼éµå¾ªçš„ã€‚

    ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„PCIeæ€»çº¿ä½“ç³»ç»“æ„ï¼Œå…¶ä¸­ Device Core and interface to Transaction Layer å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åº”ç”¨å±‚æˆ–è€…è½¯ä»¶å±‚ã€‚è¿™ä¸€å±‚å†³å®šäº†PCIeè®¾å¤‡çš„ç±»å‹å’ŒåŸºç¡€åŠŸèƒ½å‘¢ä¸ªï¼Œå¯ä»¥ç”±ç¡¬ä»¶(å¦‚FPGA)æˆ–è€…è½¯ç¡¬ä»¶ç³»ç»Ÿå®ç°ã€‚

    1. å¦‚æœè¯¥è®¾å¤‡ä¸ºEnpointï¼Œåˆ™å…¶æœ€å¤šå¯æ‹¥æœ‰8é¡¹åŠŸèƒ½(Function)ï¼Œä¸”æ¯é¡¹åŠŸèƒ½éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é…ç½®ç©ºé—´(Configuration Space)ã€‚
    2. å¦‚æœè¯¥è®¾å¤‡ä¸ºSwitchï¼Œåˆ™åº”ç”¨å±‚éœ€è¦å®ç°åŒ…è·¯ç”±(Packet Routing)ç­‰ç›¸å…³é€»è¾‘ã€‚
    3. å¦‚æœè¯¥è®¾å¤‡ä¸ºRootï¼Œåˆ™åº”ç”¨å±‚éœ€è¦å®ç°è™šæ‹Ÿçš„PCIeæ€»çº¿0ï¼ˆVirtual PCIe Bus 0ï¼‰ï¼Œå¹¶ä»£è¡¨æ•´ä¸ªPCIeæ€»çº¿ç³»ç»Ÿä¸CPUé€šä¿¡ã€‚

    **äº‹åŠ¡å±‚ï¼ˆTransaction Layerï¼‰**ï¼š

    1. æ¥æ”¶ç«¯çš„äº‹ç‰©å±‚è´Ÿè´£äº‹åŠ¡å±‚åŒ…ï¼ˆTransaction Layer Packetï¼ŒTLPï¼‰çš„è§£ç ä¸æ ¡éªŒï¼›
    2. å‘é€ç«¯çš„äº‹åŠ¡å±‚è´Ÿè´£TLPçš„åˆ›å»ºã€‚
    3. æ­¤å¤–ï¼Œäº‹åŠ¡å±‚è¿˜æœ‰ QoSï¼ˆQuality of Serviceï¼‰å’Œæµé‡æ§åˆ¶ï¼ˆFlow Controlï¼‰ä»¥åŠTransaction Orderingç­‰åŠŸèƒ½ã€‚

    **æ•°æ®é“¾è·¯å±‚ï¼ˆData Link Layerï¼‰**ï¼š

    1. è´Ÿè´£æ•°æ®é“¾è·¯å±‚åŒ…ï¼ˆData Link Layer Packetï¼ŒDLLPï¼‰çš„åˆ›å»ºã€è§£ç å’Œæ ¡éªŒã€‚
    2. åŒæ—¶ï¼Œæœ¬å±‚è¿˜å®ç°äº†Ack/Nakçš„åº”ç­”æœºåˆ¶ã€‚

    **ç‰©ç†å±‚ï¼ˆPhysical Layerï¼‰**:

    1. ç‰©ç†å±‚è´Ÿè´£Ordered-Set Packet çš„åˆ›å»ºä¸è§£ç ã€‚åŒæ—¶è´Ÿè´£å‘é€ä¸æ¥æ”¶æ‰€æœ‰ç±»å‹çš„åŒ…ï¼ˆTLPsã€DLLPså’ŒOrdered-Setsï¼‰ã€‚
    2. åœ¨å‘é€ä¹‹å‰ï¼Œè¿˜éœ€è¦å¯¹åŒ…è¿›è¡Œä¸€äº›åˆ—çš„å¤„ç†ï¼Œå¦‚Byte Stipingã€Scramnleï¼ˆæ‰°ç ï¼‰å’ŒEncoderï¼ˆ8b/10b for Gen1 & Gen2ï¼Œ128b/130b for Gen3 & Gen4ï¼‰ã€‚å¯¹åº”çš„ï¼Œåœ¨æ¥æ”¶ç«¯å°±è¦è¿›è¡Œç›¸åçš„å¤„ç†ã€‚
    3. æ­¤å¤–ï¼Œç‰©ç†å±‚è¿˜å®ç°äº†é“¾è·¯è®­ç»ƒï¼ˆLink Trainingï¼‰å’Œé“¾è·¯åˆå§‹åŒ–ï¼ˆLink Initializationï¼‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€èˆ¬æ˜¯é€šè¿‡é“¾è·¯è®­ç»ƒçŠ¶æ€æœºï¼ˆLink Training and Status Machineï¼ŒLTSSMï¼‰æ¥å®Œæˆçš„ã€‚

    éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨PCIeä½“ç³»ç»“æ„ä¸­ï¼Œäº‹åŠ¡å±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚å­˜åœ¨äºæ¯ä¸€ä¸ªç«¯å£ï¼ˆPortï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´Switchä¸­å¿…ç„¶å­˜åœ¨ä¸€ä¸ªä»¥ä¸Šçš„è¿™æ ·çš„ç»“æ„ï¼ˆåŒ…æ‹¬äº‹åŠ¡å±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚çš„ï¼‰ã€‚ä¸€ä¸ªç®€åŒ–çš„æ¨¡å‹å¦‚ç¬¬ä¸‰å¹…å›¾æ‰€ç¤ºã€‚

![img](/images/PCIeå±‚çº§ç»“æ„.png)

![img](/images/PCIeæ€»çº¿ç»“æ„.png)

[ğŸ”—](https://blog.csdn.net/weiaipan1314/article/details/104382563)

![img](/images/PCIeå±‚æ¬¡ç»“æ„åœ¨PCIeæ‹“æ‰‘å›¾ä¸­çš„å‘ˆç°.png)

å…³äºäº‹åŠ¡å±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚çš„è¯¦ç»†çš„åŠŸèƒ½å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/images/PCIeè¯¦ç»†åŠŸèƒ½å›¾.png)



15. åœ¨ä»‹ç»äº‹åŠ¡å±‚ä¹‹å‰ï¼Œé¦–å…ˆç®€å•åœ°äº†è§£ä¸€ä¸‹PCIeæ€»çº¿çš„é€šä¿¡æœºåˆ¶ã€‚å‡è®¾æŸä¸ªè®¾å¤‡è¦å¯¹å¦ä¸€ä¸ªè®¾å¤‡è¿›è¡Œè¯»å–æ•°æ®çš„æ“ä½œï¼Œé¦–å…ˆè¿™ä¸ªè®¾å¤‡ï¼ˆç§°ä¹‹ä¸ºRequesterï¼‰éœ€è¦å‘å¦ä¸€ä¸ªè®¾å¤‡å‘é€ä¸€ä¸ªRequestï¼Œç„¶åå¦ä¸€ä¸ªè®¾å¤‡ï¼ˆç§°ä¹‹ä¸ºCompleterï¼‰é€šè¿‡Completion Packet è¿”å›æ•°æ®æˆ–è€…é”™è¯¯ä¿¡æ¯ã€‚åœ¨PCIe Specä¸­ï¼Œè§„å®šäº†å››ç§ç±»å‹çš„è¯·æ±‚ï¼ˆRequestï¼‰ï¼šMemoryã€IOã€Configurationå’ŒMessagesã€‚å…¶ä¸­å‰ä¸‰ç§éƒ½æ˜¯ä»PCI/PCI-Xæ€»çº¿ä¸­ç»§æ‰¿è¿‡æ¥çš„ï¼Œç¬¬å››ç§Messagesæ˜¯PCIeæ–°å¢åŠ çš„ç±»å‹ã€‚è¯¦ç»†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/images/PCIeå››ç§è¯·æ±‚ç±»å‹.png)

ä»è¡¨ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªæœ‰Memory Writeå’ŒMessageæ˜¯Postedç±»å‹çš„ï¼Œå…¶ä»–çš„éƒ½æ˜¯Non-Postedç±»å‹çš„ã€‚æ‰€è°“Non-Postedï¼Œå°±æ˜¯Requesterå‘é€äº†ä¸€ä¸ªåŒ…å«Requestçš„åŒ…ä¹‹åï¼Œå¿…é¡»è¦å¾—åˆ°åŒ…å«Completionçš„åŒ…çš„åº”ç­”ï¼Œè¿™æ¬¡ä¼ è¾“æ‰ç®—ç»“æŸï¼Œå¦åˆ™ä¼šè¿›è¡Œç­‰å¾…ã€‚æ‰€è°“Postedï¼Œå°±æ˜¯Requesterçš„è¯·æ±‚å¹¶ä¸éœ€è¦Completeré€šè¿‡å‘é€åŒ…å«Completionçš„åŒ…è¿›è¡Œåº”ç­”ï¼Œå½“ç„¶ä¹Ÿå°±ä¸éœ€è¦è¿›è¡Œç­‰å¾…äº†ã€‚å¾ˆæ˜¾ç„¶ï¼ŒPostedç±»å‹çš„æ“ä½œå¯¹æ€»çº¿çš„åˆ©ç”¨ç‡ï¼ˆæ•ˆç‡ï¼‰è¦è¿œé«˜äºNon-Postedã€‚

é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åˆ†ä¸ºNon-Postedå’ŒPostedä¸¤ç§ç±»å‹å‘¢ï¼Ÿå¯¹äºMemory Writesæ¥è¯´ï¼Œå¯¹æ•ˆç‡è¦æ±‚è¾ƒé«˜ï¼Œå› æ­¤é‡‡ç”¨äº†Postedçš„æ–¹å¼ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€Postedç±»å‹çš„æ“ä½œå®Œå…¨ä¸éœ€è¦Completerè¿›è¡Œåº”ç­”ï¼ŒCompleterä»ç„¶å¯é‡‡ç”¨å¦ä¸€ç§åº”ç­”æœºåˆ¶â€”â€”Ack/Nakçš„æœºåˆ¶ï¼ˆåœ¨æ•°æ®é“¾è·¯å±‚å®ç°çš„ï¼‰ã€‚

16. PCIeçš„TLPåŒ…ä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

![img](/images/TLPåŒ…çš„ç±»å‹.png)

17. TLPä¼ è¾“çš„ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/images/TLPä¼ è¾“çš„ç¤ºæ„å›¾.png)

18. TLPåœ¨æ•´ä¸ªPCIeåŒ…ç»“æ„çš„ä½ç½®å¦‚ä»¥ä¸‹ä¸¤å¼ å›¾æ‰€ç¤ºï¼šï¼ˆç¬¬ä¸€å¼ ä¸ºå‘é€ç«¯ï¼Œç¬¬äºŒå¼ ä¸ºæ¥æ”¶ç«¯ï¼‰

![img](/images/å‘é€TLPåŒ….png)

![img](/images/æ¥æ”¶TLPåŒ….png)

19. å…¶ä¸­ï¼ŒTLPåŒ…ç»“æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/images/TLPåŒ…ç»“æ„.png)

å›¾ä¸­çš„TLP Digestå³ECRCï¼ˆEnd-to-End CRCï¼‰ï¼Œæ˜¯å¯é€‰é¡¹ã€‚æ­¤å¤–ï¼ŒTLPçš„é•¿åº¦ï¼ˆåŒ…æ‹¬å…¶ä¸­çš„Headerã€Dataå’ŒECRCï¼‰æ˜¯ä»¥DWï¼ˆåŒå­—ï¼Œå³å››å­—èŠ‚ï¼‰ä¸ºå•ä½çš„ã€‚

20. ä¸‹é¢èŠä¸€èŠNon-Posted Transactionï¼ˆåŒ…æ‹¬Ordinary Readã€Locked Readå’ŒIO/Configuration Writesï¼‰ä¸Posted Writesï¼ˆåŒ…æ‹¬Memory Writeså’ŒMessage Writesï¼‰ã€‚

    1. Non-Posted Transaction

       1. Ordinary Reads

          ä¸‹å›¾æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªEndpointå‘System Memoryå‘é€è¯»è¯·æ±‚ï¼ˆRead Requestï¼‰çš„ä¾‹å­ã€‚

![img](/images/Non-Posted.png)

â€‹					åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒEndpointçš„è¯»è¯·æ±‚é€šè¿‡äº†ä¸¤ä¸ªSwitchï¼Œç„¶ååˆ°è¾¾å…¶ç›®æ ‡ï¼Œå³Rootã€‚Rootå¯¹è¯»è¯·æ±‚çš„åŒ…è¿›è¡Œè§£ç åï¼Œå¹¶ä»ä¸­è¯†åˆ«å‡ºæ“ä½œçš„åœ°å€ï¼Œç„¶åé”å­˜æ•°æ®ï¼Œå¹¶å°†æ•°æ®å‘é€è‡³Endpointï¼Œå³åŒ…å«æ•°æ®çš„CompletionåŒ…ï¼ŒClpDã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPCIeå…è®¸æ¯ä¸ªåŒ…çš„æœ€å¤§æ•°æ®é‡ï¼ˆMax Data Payloadï¼‰ä¸º4KBï¼Œä½†å®é™…ä¸Šè®¾è®¡è€…å¾€å¾€ä¼šé‡‡ç”¨è¾ƒå°çš„Max Payload Sizeï¼ˆæ¯”å¦‚128ï¼Œ256ï¼Œ512ï¼Œ1024å’Œ2048ï¼‰ã€‚å› æ­¤ï¼Œå¸¸å¸¸ä¸€ä¸ªè¯»è¯·æ±‚ä¼šå¯¹åº”å¯¹ä¸ªClpDï¼Œå³å°†å¤§äºMax Payload Sizeçš„æ•°æ®åˆ†æˆå¤šä¸ªåŒ…å‘é€ã€‚å¦‚æœé‡åˆ°é”™è¯¯ï¼Œåˆ™Rootä¼šé€šè¿‡CompletionåŒ…å‘ŠçŸ¥å“åº”çš„Endpointã€‚

â€‹					æ³¨ï¼šRootå‘å‘é€è¯·æ±‚çš„Enpointå‘é€CompletionåŒ…ï¼Œæ˜¯é€šè¿‡RequeståŒ…ä¸­çš„BDFä¿¡æ¯ï¼ˆBusï¼ŒDeviceå’ŒFunctionï¼‰è¿›è¡ŒæŸ¥æ‰¾å¯¹åº”çš„Endpointçš„ã€‚

2. â€‹	Posted Writes
   
1. Memory Writes
          

PCIeä¸­çš„Memoryå†™æ“ä½œéƒ½æ˜¯Postedçš„ï¼Œå› æ­¤Requesterå¹¶ä¸éœ€è¦æ¥è‡ªCompleterçš„Completionã€‚ä¸€ä¸ªç®€å•çš„Memory Writesä¾‹å­å¦‚ä¸‹
          
![img](/images/posted.png)
          
å› ä¸ºæ²¡æœ‰è¿”å›Completionï¼Œæ‰€ä»¥å½“å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒRequesterä¹Ÿä¸çŸ¥é“ã€‚ä½†æ˜¯ï¼Œæ­¤æ—¶Completerä¼šå°†é”™è¯¯è®°å½•åˆ°æ—¥å¿—ï¼ˆLogï¼‰ï¼Œç„¶åå‘Rootå‘é€åŒ…å«é”™è¯¯ä¿¡æ¯çš„Messageã€‚

21. PCIeæ€»çº¿è®¾è®¡ä¹‹åˆï¼Œå……åˆ†è€ƒè™‘åˆ°äº†éŸ³é¢‘å’Œè§†é¢‘ä¼ è¾“ç­‰è¿™äº›å¯¹æ—¶é—´è¦æ±‚ç‰¹åˆ«æ•æ„Ÿçš„åº”ç”¨ã€‚ä¸ºäº†ä¿è¯è¿™äº›ç‰¹æ®Šåº”ç”¨çš„æ•°æ®åŒ…èƒ½å¤Ÿå¾—åˆ°ç”±å¿å‘é€ï¼ŒPCIe Specä¸­ä¸ºæ¯ä¸€ä¸ªåŒ…éƒ½åˆ†é…äº†ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé€šè¿‡TLPçš„Headerä¸­çš„3ä½ï¼ˆå³TCï¼ŒTraffic Classï¼‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/images/TC.png)

22. ç«¯å£ä»²è£

![img](/images/PCIeç«¯å£ä»²è£.png)

23. Flow Control DLLP

    PCIeæ€»çº¿ä¸­è¦æ±‚æ¥æ”¶æ–¹å¿…é¡»ç»å¸¸ï¼ˆåœ¨ç‰¹å®šæ—¶é—´ï¼‰å‘å‘é€æ–¹æŠ¥å‘Šå…¶VC Bufferçš„ä½¿ç”¨æƒ…å†µã€‚æ–¹å¼æ˜¯ä½¿ç”¨ Flow Control DDLPï¼ˆæ•°æ®é“¾è·¯å±‚åŒ…ï¼‰ã€‚

![img](/images/Flow-Control.png)

24. æ•°æ®é“¾è·¯å±‚ä¸ä»…å¯ä»¥è½¬å‘TLPï¼Œè¿˜å¯ä»¥ç›´æ¥å‘å¦ä¸€ä¸ªç›¸é‚»è®¾å¤‡çš„æ•°æ®é“¾è·¯å±‚ç›´æ¥å‘é€DLLPï¼Œæ¯”å¦‚Flow Controlã€Ackå’ŒNakçš„DLLPã€‚

![img](/images/DLLP.png)

25. æˆ‘ä»¬æ‰€è¯´çš„TLPå’ŒDLLPæŒ‡çš„æ˜¯åŒ…çš„åŸå§‹å‘é€è€…å‘çš„åŒ…ï¼Œå³TLPè¡¨ç¤ºè¿™ä¸ªåŒ…çš„åŸå§‹å‘é€è€…ä½äº‹åŠ¡å±‚ï¼Œè€ŒDLLPåˆ™ä¸ºæ•°æ®é“¾è·¯å±‚ã€‚ä½†æ˜¯TLPä»ç„¶ä¼šè¢«æ•°æ®é“¾è·¯å±‚è½¬å‘ï¼Œå¹¶æ·»åŠ Sequence å’Œ LCRCã€‚

![img](/images/PCIeåŒ….png)

ç‰©ç†å±‚å®Œæˆçš„ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å°±æ˜¯8b/10bç¼–ç å’Œè§£ç ï¼ˆGen 1 & Gen2ï¼‰ï¼ŒGen 3åŠä¹‹åçš„PCIeåˆ™é‡‡ç”¨äº†128b/130bçš„ç¼–ç å’Œè§£ç æœºåˆ¶ã€‚

26. ä¸€ä¸ªMemory Readæ“ä½œçš„ä¾‹å­

![img](/images/memory-read.png)

Requesterï¼šåº”ç”¨å±‚ï¼ˆè½¯ä»¶å±‚ï¼‰ã€Memoryåœ°å€ã€äº‹åŠ¡ç±»å‹(Transaction Type)ã€æ•°æ®é‡(å•ä½DW)ã€TCã€å­—èŠ‚ä½¿èƒ½(Byte Enable)ã€å±æ€§ä¿¡æ¯(Attributes)ç­‰]ã€‘--> äº‹åŠ¡å±‚ ã€ + Header ã€ IDï¼ˆBDFï¼ŒBus & Device & Functionï¼‰ã€ = Mrd TLP ã€‘-> VC Buffer  ?>  <- Flow Control --> æ•°æ®é“¾è·¯å±‚ ã€ + 12ä½çš„Sequence Numberã€32ä½çš„LCRC = DLLPã€‘å¤‡ä»½ --> ç‰©ç†å±‚ ã€+ Start & End Charactersï¼Œè§£å­—èŠ‚ï¼ˆStrip Byteï¼‰ã€æ‰°ç ï¼ˆScrambleï¼‰ã€8b/10bç¼–ç å¹¶è¿›è¡Œä¸²è¡ŒåŒ–ã€‘ --> ç›¸é‚»çš„ç‰©ç†å±‚









## å‚è€ƒ

[PCIä¸PCIeå­¦ä¹ ä¸€â€”â€”ç¡¬ä»¶ç¯‡](https://blog.csdn.net/u013253075/article/details/80835489)