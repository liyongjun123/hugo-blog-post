---
title: "ELF"
date: 2020-10-29T23:11:52+08:00
draft: false
categories: ["C"]
tags: ["学习"]
toc: false
url: /2020/10/29/elf.html
---

## ELF

在 Linux 中，二进制可执行文件的标准格式叫做 ELF（Executable and Linkable Format）。从名字可以看出，它同时兼容可执行文件和可链接文件。



## 实例

elfdemo.c

```c
#include <stdio.h>
#include <stdlib.h>

static char static_data[16] = "I'm Static Data";
static char raw_static_data[40960];
static const char const_data[16] = "I'm Const Data";

int main(int args, char **argv)
{
	printf("Message In Main\n");

	return 0;
}
```

gcc -o elfdemo.out -no-pie elfdemo.c

```bash
$ ls -l elfdemo.out 
-rwxrwxr-x 1 liyongjun liyongjun 16744 10月 29 23:21 elfdemo.out

$ file elfdemo.out 
elfdemo.out: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=d31074c23465f875f6d188cea193a3c66bbb049c, for GNU/Linux 3.2.0, not stripped

$ readelf -h elfdemo.out 
ELF 头：
  Magic：   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  类别:                              ELF64
  数据:                              2 补码，小端序 (little endian)
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI 版本:                          0
  类型:                              EXEC (可执行文件)
  系统架构:                          Advanced Micro Devices X86-64
  版本:                              0x1
  入口点地址：               0x401050
  程序头起点：          64 (bytes into file)
  Start of section headers:          14760 (bytes into file)
  标志：             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         13
  Size of section headers:           64 (bytes)
  Number of section headers:         31
  Section header string table index: 30

```

- 可执行文件的大小是 16744 字节
- 文件格式是 64 位的 Linux 标准可执行文件（ELF 64-bit LSB executable），目标平台是 x86-64
- 程序的入口地址是 0x401050
- 该文件的 ELF 头的大小是 64 字节
- 文件中有 13 个 Program Header，每个 Program Header 的长度是 56 字节，信息存放在从文件头算起 64 字节的位置（程序头起点）
- 另外还有 31 个 Section Header，每个 Section Header 的大小是 64 字节，信息存放在从文件头算起 14760 字节的位置

根据这些信息，就可以依次定位到每个 Header，再根据 Header 中对每个段的描述，便可解析出文件内容。

## 组成部分之程序头和节区头

```bash
$ readelf -l elfdemo.out 

Elf 文件类型为 EXEC (可执行文件)
Entry point 0x401050
There are 13 program headers, starting at offset 64

程序头：
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040
                 0x00000000000002d8 0x00000000000002d8  R      0x8
  INTERP         0x0000000000000318 0x0000000000400318 0x0000000000400318
                 0x000000000000001c 0x000000000000001c  R      0x1
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
                 0x00000000000004d0 0x00000000000004d0  R      0x1000
  LOAD           0x0000000000001000 0x0000000000401000 0x0000000000401000
                 0x00000000000001e5 0x00000000000001e5  R E    0x1000
  LOAD           0x0000000000002000 0x0000000000402000 0x0000000000402000
                 0x0000000000000178 0x0000000000000178  R      0x1000
  LOAD           0x0000000000002e10 0x0000000000403e10 0x0000000000403e10
                 0x0000000000000230 0x000000000000a250  RW     0x1000
  DYNAMIC        0x0000000000002e20 0x0000000000403e20 0x0000000000403e20
                 0x00000000000001d0 0x00000000000001d0  RW     0x8
  NOTE           0x0000000000000338 0x0000000000400338 0x0000000000400338
                 0x0000000000000020 0x0000000000000020  R      0x8
  NOTE           0x0000000000000358 0x0000000000400358 0x0000000000400358
                 0x0000000000000044 0x0000000000000044  R      0x4
  GNU_PROPERTY   0x0000000000000338 0x0000000000400338 0x0000000000400338
                 0x0000000000000020 0x0000000000000020  R      0x8
  GNU_EH_FRAME   0x0000000000002030 0x0000000000402030 0x0000000000402030
                 0x0000000000000044 0x0000000000000044  R      0x4
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10
  GNU_RELRO      0x0000000000002e10 0x0000000000403e10 0x0000000000403e10
                 0x00000000000001f0 0x00000000000001f0  R      0x1

 Section to Segment mapping:
  段节...
   00     
   01     .interp 
   02     .interp .note.gnu.property .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt 
   03     .init .plt .plt.sec .text .fini 
   04     .rodata .eh_frame_hdr .eh_frame 
   05     .init_array .fini_array .dynamic .got .got.plt .data .bss 
   06     .dynamic 
   07     .note.gnu.property 
   08     .note.gnu.build-id .note.ABI-tag 
   09     .note.gnu.property 
   10     .eh_frame_hdr 
   11     
   12     .init_array .fini_array .dynamic .got 
```

以上信息指出该 ELF  文件有 13 个段